<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TerraVitalis - Global Data Interface</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Leaflet.js for interactive maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <style>
        html {
            /* Prevents the entire page from bouncing on mobile */
            overscroll-behavior: none;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0a0a0a;
            color: #e5e7eb;
            /* These properties lock the body in place, creating an app-like feel */
            position: fixed;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            overscroll-behavior: none;
        }
        #map-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #1a202c; /* Fallback for map tiles */
            touch-action: none; /* Prevents page scroll when panning map on mobile */
        }
        /* Style for Leaflet attribution */
        .leaflet-control-attribution {
            background: rgba(23, 23, 23, 0.7) !important;
            color: #a0aec0 !important;
        }
        .leaflet-control-attribution a {
            color: #cbd5e0 !important;
        }
        .glass-panel {
            background: rgba(23, 23, 23, 0.8);
            backdrop-filter: blur(14px);
            -webkit-backdrop-filter: blur(14px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .hex-grid {
            position: relative;
            width: 100%;
            height: 100%;
            pointer-events: all;
            transform: perspective(1000px) rotateX(30deg);
            transform-origin: bottom center;
            opacity: 0;
            animation: fadeInGrid 0.7s ease-out forwards;
        }
        @keyframes fadeInGrid {
            to {
                opacity: 1;
                transform: perspective(1000px) rotateX(0deg);
            }
        }
        .hex {
            position: relative;
            width: 80px;
            height: 92.38px;
            margin: 0 auto;
            clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
            cursor: pointer;
            transition: transform 0.2s ease-in-out, background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .hex:hover {
            transform: scale(1.15);
            z-index: 10;
        }
        .hex.selected {
            transform: scale(1.1);
            box-shadow: 0 0 0 3px #a78bfa;
            z-index: 5;
        }
        .hex-value {
            font-size: 14px;
            font-weight: 700;
            color: white;
            text-shadow: 0 1px 3px rgba(0,0,0,0.7);
            pointer-events: none; /* So it doesn't interfere with hex hover */
        }
        #hex-tooltip {
            position: absolute;
            display: none;
            padding: 8px 12px;
            font-size: 14px;
            z-index: 9999;
            pointer-events: none;
            transition: opacity 0.2s;
        }
        .active-toggle { background-color: #4f46e5; color: white; }
        .inactive-toggle { background-color: #374151; color: #d1d5db; }
        .active-rank-item { background-color: rgba(79, 70, 229, 0.3); border-left: 2px solid #6366f1; }
        .gemini-output h4 { font-size: 1.125rem; font-weight: 600; margin-bottom: 0.5rem; }
        .gemini-output ul { list-style-position: inside; list-style-type: disc; padding-left: 0.5rem; margin-top: 0.5rem; space-y: 0.25rem; }
        .gemini-output strong { font-weight: 600; color: #c4b5fd; }
        .loader {
            width: 20px;
            height: 20px;
            border: 2px solid #FFF;
            border-bottom-color: transparent;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #street-view-placeholder { height: 150px; width: 100%; border-radius: 0.5rem; background-color: #1f2937; display: flex; align-items: center; justify-content: center; text-align: center;}
        
        /* Styles for new interactive city markers */
        .pulsing-marker {
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 0 rgba(167, 139, 250, 0.4);
            animation: pulse 2.5s infinite cubic-bezier(0.66, 0, 0, 1);
            border: 2px solid rgba(255, 255, 255, 0.9);
            transition: transform 0.2s ease-in-out;
        }

        @keyframes pulse {
            0% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(167, 139, 250, 0.7);
            }
            70% {
                transform: scale(1);
                box-shadow: 0 0 0 12px rgba(167, 139, 250, 0);
            }
            100% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(167, 139, 250, 0);
            }
        }

        /* --- STAKEHOLDER MODAL STYLES --- */
        #stakeholder-content-wrapper {
            font-family: 'Inter', sans-serif;
            color: #e5e7eb;
            padding: 1.5rem; /* Simplified to a basic block container */
        }
        #stakeholder-content-wrapper .map-wrapper {
            width: 100%;
            max-width: 1400px;
            position: relative;
        }
        #stakeholder-content-wrapper .controls {
            position: absolute;
            top: -3.5rem;
            right: 0;
            display: flex;
            gap: 0.5rem;
            z-index: 100;
        }
        #stakeholder-content-wrapper .control-btn {
            background-color: rgba(55, 65, 81, 0.7);
            border: 1px solid rgba(75, 85, 99, 0.8);
            color: #d1d5db;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            font-weight: 600;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        #stakeholder-content-wrapper .control-btn:hover {
            background-color: #4f46e5;
            color: white;
            border-color: #818cf8;
        }
        #stakeholder-content-wrapper .mindmap-container {
            display: flex;
            align-items: center;
            justify-content: center; /* Center the map horizontally */
            width: 100%;
        }
        #stakeholder-content-wrapper .tree { display: flex; align-items: center; justify-content: flex-start; }
        #stakeholder-content-wrapper .tree ul { padding-left: 48px; position: relative; display: flex; flex-direction: column; gap: 1.25rem; }
        #stakeholder-content-wrapper .tree li { list-style-type: none; position: relative; display: flex; flex-direction: column; align-items: flex-start; justify-content: center; }
        #stakeholder-content-wrapper .node {
            display: inline-block;
            padding: 0.75rem 1.25rem;
            border-radius: 0.75rem;
            background: rgba(31, 41, 55, 0.9);
            border: 1px solid rgba(75, 85, 99, 0.7);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            width: 280px;
            position: relative;
            z-index: 10;
        }
        #stakeholder-content-wrapper .node:hover {
            transform: translateY(-4px) scale(1.03);
            border-color: #a5b4fc;
            box-shadow: 0 0 25px rgba(129, 140, 248, 0.3);
        }
        #stakeholder-content-wrapper .node-header { display: flex; align-items: center; gap: 0.75rem; }
        #stakeholder-content-wrapper .node-icon { width: 2.25rem; height: 2.25rem; flex-shrink: 0; display: flex; align-items: center; justify-content: center; border-radius: 0.5rem; background-color: rgba(0,0,0,0.2); }
        #stakeholder-content-wrapper .node-content {
            transition: max-height 0.5s ease-in-out, opacity 0.3s ease-in-out, margin-top 0.5s ease-in-out;
            max-height: 0; overflow: hidden; opacity: 0;
        }
        #stakeholder-content-wrapper .node.expanded .node-content { max-height: 500px; opacity: 1; margin-top: 1rem; }
        #stakeholder-content-wrapper .node.root { background: linear-gradient(145deg, #4338ca, #6366f1); color: white; border: none; width: auto; box-shadow: 0 10px 30px rgba(79, 70, 229, 0.4); }
        #stakeholder-content-wrapper .node.primary { background-color: rgba(55, 65, 81, 0.9); border-color: #6366f1; }
        #stakeholder-content-wrapper .node.secondary { background-color: rgba(30, 41, 59, 0.9); border-color: #4b5563; }
        #stakeholder-content-wrapper .node.tertiary { background-color: rgba(17, 24, 39, 0.9); border-color: #374151; }
        #stakeholder-content-wrapper .stakeholder-type {
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.125rem 0.5rem;
            border-radius: 9999px;
            color: #e5e7eb;
            background-color: rgba(255, 255, 255, 0.1);
            margin-top: 0.25rem;
        }
        #stakeholder-content-wrapper .engagement-level {
            margin-top: 0.75rem;
            background-color: rgba(0,0,0,0.3);
            border-radius: 9999px;
            overflow: hidden;
            height: 6px;
        }
        #stakeholder-content-wrapper .engagement-bar {
            height: 100%;
            border-radius: 9999px;
            background: linear-gradient(to right, #818cf8, #a78bfa);
            transition: width 0.5s ease;
        }
        #stakeholder-content-wrapper .tree ul ul { display: none; }
        #stakeholder-content-wrapper li.expanded > ul { display: flex; }
        #stakeholder-content-wrapper .tree li::before { content: ''; position: absolute; top: 50%; left: 0; border-top: 2px solid #374151; width: 48px; height: 0; transform: translateY(-50%); z-index: 1; }
        #stakeholder-content-wrapper .tree > li > .node { transform: translateX(-48px); }
        #stakeholder-content-wrapper .tree > li::before { display:none; }
        #stakeholder-content-wrapper .tree li::after { content: ''; position: absolute; top: 0; left: 0; border-left: 2px solid #374151; width: 0; height: 100%; z-index: 1; }
        #stakeholder-content-wrapper .tree li:first-child::after { height: 50%; top: 50%; }
        #stakeholder-content-wrapper .tree li:last-child::after { height: 50%; }
        #stakeholder-content-wrapper .tree li:only-child::after { display: none; }
        #stakeholder-content-wrapper .toggle-icon {
            position: absolute; right: -14px; top: 50%; transform: translateY(-50%); width: 28px; height: 28px; background-color: #374151; color: #d1d5db; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: bold; z-index: 20; transition: transform 0.3s ease, background-color 0.3s ease; border: 2px solid #4b5563;
        }
        li.expanded > .node > .toggle-icon { transform: translateY(-50%) rotate(45deg); background-color: #818cf8; color: white; }

        @media (max-width: 1024px) {
            /* The align-items property is removed as the wrapper is no longer a flex container */
            #stakeholder-content-wrapper .map-wrapper { padding-top: 4rem; }
            #stakeholder-content-wrapper .mindmap-container { justify-content: center; }
            #stakeholder-content-wrapper .tree, #stakeholder-content-wrapper .tree ul { flex-direction: column; align-items: flex-start; }
            #stakeholder-content-wrapper .tree ul { padding-left: 24px; gap: 0; }
            #stakeholder-content-wrapper .tree li { padding: 1.25rem 0; }
            #stakeholder-content-wrapper .node { width: calc(100vw - 4.5rem); max-width: 400px; }
            #stakeholder-content-wrapper .tree li::before { top: 0; left: -24px; width: 0; height: 50%; border-left: 2px solid #374151; border-top: none; transform: translateX(50%); }
            #stakeholder-content-wrapper .tree > li > .node { transform: translateX(0); }
            #stakeholder-content-wrapper .tree li::after { top: 0; left: -24px; border-left: 2px solid #374151; transform: translateX(50%); }
            #stakeholder-content-wrapper .tree > li::before, #stakeholder-content-wrapper .tree > li::after { display: none; }
            #stakeholder-content-wrapper li > ul > li:first-child::before { border-top: 2px solid #374151; border-left: none; width: 24px; height: 0; left: -24px; top: 50%; transform: translateY(-50%); }
            #stakeholder-content-wrapper li > ul > li::before { display: none; }
            #stakeholder-content-wrapper li > ul > li::after { left: -24px; top: -1.25rem; height: calc(100% + 2.5rem); }
            #stakeholder-content-wrapper li > ul > li:first-child::after { top: 50%; height: calc(50% + 1.25rem); }
            #stakeholder-content-wrapper li > ul > li:last-child::after { height: calc(50% + 1.25rem); }
            #stakeholder-content-wrapper .toggle-icon { right: 1rem; top: 1.1rem; transform: translateY(0); }
            #stakeholder-content-wrapper li.expanded > .node > .toggle-icon { transform: rotate(45deg); }
        }
    </style>
</head>
<body class="overflow-hidden h-screen">

    <div id="app" class="h-full w-full flex flex-col relative">
        <div id="map-container"></div>
        <div id="hex-tooltip" class="glass-panel rounded-md text-white"></div>

        <header class="w-full p-4 flex flex-col sm:flex-row justify-between sm:items-center gap-4 sm:gap-0 z-[1001] absolute top-0 left-0 pointer-events-none">
            <div class="flex items-center justify-between w-full pointer-events-auto sm:w-auto">
                <div class="flex items-center space-x-2">
                    <button id="menu-toggle-btn" class="p-2 rounded-lg glass-panel hover:bg-gray-700 transition-colors border-indigo-600">
                        <svg class="w-6 h-6 text-white" id="menu-open-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                        <svg class="w-6 h-6 text-white hidden" id="menu-close-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                    <div class="flex items-center gap-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 sm:w-10 sm:h-10 text-indigo-400" viewBox="0 0 200 200">
                            <g>
                                <!-- Octagon Frame -->
                                <path d="M141.42,29.29,100,10,58.58,29.29,29.29,58.58,10,100l19.29,41.42L58.58,170.71,100,190l41.42-19.29L170.71,141.42,190,100,170.71,58.58Z" fill="none" stroke="currentColor" stroke-width="12"/>
                                <!-- Tree -->
                                <g fill="currentColor" stroke="none">
                                    <!-- Trunk -->
                                    <path d="M94,170 C94,160 92,120 92,110 H108 C108,120 106,160 106,170 Z" />
                                    <!-- Main Branches -->
                                    <path d="M100,112 C85,108 78,95 78,80" stroke="currentColor" stroke-width="10" fill="none" stroke-linecap="round"/>
                                    <path d="M100,112 C115,108 122,95 122,80" stroke="currentColor" stroke-width="10" fill="none" stroke-linecap="round"/>
                                    <path d="M96,110 C96,100 90,95 85,85" stroke="currentColor" stroke-width="7" fill="none" stroke-linecap="round"/>
                                    <path d="M104,110 C104,100 110,95 115,85" stroke="currentColor" stroke-width="7" fill="none" stroke-linecap="round"/>
                                    <path d="M118,82 C125,75 128,65 125,55" stroke="currentColor" stroke-width="6" fill="none" stroke-linecap="round"/>
                                    <path d="M82,82 C75,75 72,65 75,55" stroke="currentColor" stroke-width="6" fill="none" stroke-linecap="round"/>
                                    <!-- Leaves (as filled paths) -->
                                    <path d="M95,30 C90,40 95,50 100,50 C105,50 110,40 105,30 Z" />
                                    <path d="M110,38 C105,48 110,58 115,58 C120,58 125,48 120,38 Z" transform="rotate(20 115 48)"/>
                                    <path d="M90,38 C85,48 90,58 95,58 C100,58 105,48 100,38 Z" transform="rotate(-20 95 48)"/>
                                    <path d="M130,55 C125,65 130,75 135,75 C140,75 145,65 140,55 Z" transform="rotate(45 135 65)"/>
                                    <path d="M70,55 C65,65 70,75 75,75 C80,75 85,65 80,55 Z" transform="rotate(-45 75 65)"/>
                                    <path d="M140,85 C135,95 140,105 145,105 C150,105 155,95 150,85 Z" transform="rotate(70 145 95)"/>
                                    <path d="M60,85 C55,95 60,105 65,105 C70,105 75,95 70,85 Z" transform="rotate(-70 65 95)"/>
                                    <path d="M125,110 C120,120 125,130 130,130 C135,130 140,120 135,110 Z" transform="rotate(100 130 120)"/>
                                    <path d="M75,110 C70,120 75,130 80,130 C85,130 90,120 85,110 Z" transform="rotate(-100 80 120)"/>
                                    <path d="M110,80 C105,90 110,100 115,100 C120,100 125,90 120,80 Z" />
                                    <path d="M90,80 C85,90 90,100 95,100 C100,100 105,90 100,80 Z" />
                                    <path d="M75,98 C70,108 75,118 80,118 C85,118 90,108 85,98 Z" transform="rotate(-120 80 108)"/>
                                    <path d="M125,98 C120,108 125,118 130,118 C135,118 140,108 135,98 Z" transform="rotate(120 130 108)"/>
                                </g>
                            </g>
                        </svg>
                        <div>
                            <h1 class="text-xl sm:text-2xl font-extrabold text-white">Terra<span class="text-indigo-400">Vitalis</span></h1>
                            <p class="text-xs text-gray-300 tracking-wider">Nasa Space App <span class="font-semibold text-gray-200">| By Mario Di Muro</span></p>
                        </div>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <button id="stakeholder-btn" class="flex items-center space-x-2 glass-panel p-2 rounded-lg hover:bg-gray-700 transition-colors border border-cyan-500">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                        <span id="stakeholder-text" class="font-semibold text-sm hidden sm:block">Stakeholders</span>
                    </button>
                    <button id="guide-btn" class="flex items-center space-x-2 glass-panel p-2 rounded-lg hover:bg-gray-700 transition-colors border border-purple-500">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.546-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <span id="guide-text" class="font-semibold text-sm hidden sm:block">Guide</span>
                    </button>
                    <button id="lang-switcher" class="flex items-center space-x-2 glass-panel p-2 rounded-lg hover:bg-gray-700 transition-colors border-indigo-600">
                        <img id="lang-flag" src="https://flagcdn.com/w20/gb.png" alt="Language flag" class="w-5 h-auto rounded-sm">
                        <span id="lang-text" class="font-semibold text-sm">EN</span>
                    </button>
                </div>
            </div>
            <div id="view-toggle" class="glass-panel p-1 rounded-full flex items-center space-x-1 pointer-events-auto w-full max-w-sm self-center sm:w-auto sm:self-auto">
                <button id="city-view-btn" class="flex-1 px-3 sm:px-4 py-1.5 text-sm font-semibold rounded-full transition-colors duration-300">City Readiness (CECR)</button>
                <button id="neighborhood-view-btn" class="flex-1 px-3 sm:px-4 py-1.5 text-sm font-semibold rounded-full transition-colors duration-300">Neighborhood Priority (NSI)</button>
            </div>
        </header>
        
        <div id="disclaimer-banner" class="absolute top-24 sm:top-[76px] left-1/2 -translate-x-1/2 w-11/12 max-w-4xl z-[1001] glass-panel border-yellow-500/50 p-3 rounded-lg text-sm shadow-lg flex items-start sm:items-center justify-between pointer-events-auto">
            <div class="flex items-start sm:items-center">
                    <svg class="w-5 h-5 text-yellow-400 mr-3 flex-shrink-0 mt-0.5 sm:mt-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                    <p id="disclaimer-content" class="text-gray-300"></p>
            </div>
            <button id="close-disclaimer" class="ml-4 text-gray-400 hover:text-white text-2xl leading-none flex-shrink-0">&times;</button>
        </div>

        <aside id="control-panel" class="w-80 sm:w-1/4 max-w-sm h-full p-4 space-y-4 overflow-y-auto glass-panel pointer-events-auto absolute top-0 left-0 z-[1002] transform -translate-x-full transition-transform duration-300 ease-in-out flex flex-col">
            <button id="menu-close-btn-panel" class="absolute top-4 right-4 text-gray-400 hover:text-white text-3xl z-10">&times;</button>
            
            <!-- Quick Access Buttons -->
            <div class="space-y-2 pt-10">
                 <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wider px-2">Quick Access</h3>
                 <button id="menu-guide-btn" class="w-full text-left p-2.5 rounded-md font-semibold text-sm bg-gray-800 hover:bg-gray-700 flex items-center gap-3">
                    <svg class="w-5 h-5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.546-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <span id="guide-menu-text">App Guide</span>
                </button>
                <button id="menu-stakeholder-btn" class="w-full text-left p-2.5 rounded-md font-semibold text-sm bg-gray-800 hover:bg-gray-700 flex items-center gap-3">
                    <svg class="w-5 h-5 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                    <span id="stakeholder-menu-text">Stakeholder Map</span>
                </button>
                 <button id="menu-cecr-btn" class="w-full text-left p-2.5 rounded-md font-semibold text-sm bg-gray-800 hover:bg-gray-700 flex items-center gap-3">
                    <svg class="w-5 h-5 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l5.447 2.724A1 1 0 0021 16.382V5.618a1 1 0 00-1.447-.894L15 7m-6 3l6-3m0 0l6 3m-6-3v10"></path></svg>
                    <span id="cecr-menu-text">City View (CECR)</span>
                </button>
                 <button id="menu-nsi-btn" class="w-full text-left p-2.5 rounded-md font-semibold text-sm bg-gray-800 hover:bg-gray-700 flex items-center gap-3">
                    <svg class="w-5 h-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    <span id="nsi-menu-text">Neighborhood View (NSI)</span>
                </button>
            </div>
            
            <hr class="border-white/10 !my-6" />

            <!-- Unified Controls Container -->
            <div id="unified-controls" class="space-y-4">
                <!-- City View Section -->
                <div id="city-menu-section" class="space-y-4">
                        <button id="city-list-toggle-btn" class="w-full text-left p-2.5 rounded-t-md font-semibold text-base bg-gray-800 hover:bg-gray-700 flex justify-between items-center">
                            <div class="flex items-center truncate">
                                <span id="select-city-title">Select City</span>
                                <span id="selected-city-name-menu" class="text-indigo-400 font-normal ml-2 truncate"></span>
                            </div>
                            <svg id="city-list-arrow" class="w-5 h-5 transition-transform flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div id="city-ranking-list-container" class="hidden bg-gray-900/50 p-2 rounded-b-md">
                            <div id="city-ranking-list" class="space-y-1"></div>
                        </div>
                        <div>
                            <h2 id="city-rankings-title" class="text-lg font-bold mb-2">City Edible Conversion Readiness(CECR)</h2>
                        </div>
                    
                        <button id="cecr-scope-btn" class="w-full text-left p-2.5 rounded-t-md font-semibold text-sm bg-gray-800 hover:bg-gray-700 flex justify-between items-center">
                            <span id="cecr-scope-title">Tool Scope (CECR)</span>
                            <svg class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div id="cecr-scope-content" class="hidden text-sm text-gray-300 bg-gray-900/50 p-3 rounded-b-md space-y-2"></div>

                        <button id="city-data-source-btn" class="w-full text-left p-2.5 rounded-t-md font-semibold text-sm bg-gray-800 hover:bg-gray-700 flex justify-between items-center">
                            <span id="nasa-data-source-title-cecr">NASA Data Sources (CECR)</span>
                            <svg id="city-arrow" class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div id="city-data-source-content" class="hidden text-sm text-gray-300 bg-gray-900/50 p-3 rounded-b-md space-y-2"></div>
                </div>
                
                <hr class="border-white/10 my-4" id="menu-divider" />

                <!-- Neighborhood View Section -->
                <div id="neighborhood-menu-section" class="space-y-4">
                        <div>
                            <h2 class="text-lg font-bold mb-2"><span id="neighborhood-analysis-title">Neighborhood NutriShade Index (NSI)</span>: <span id="city-name-label" class="text-indigo-400"></span></h2>
                        </div>
                    
                        <button id="nsi-scope-btn" class="w-full text-left p-2.5 rounded-t-md font-semibold text-sm bg-gray-800 hover:bg-gray-700 flex justify-between items-center">
                            <span id="nsi-scope-title">Tool Scope (NSI)</span>
                            <svg class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div id="nsi-scope-content" class="hidden text-sm text-gray-300 bg-gray-900/50 p-3 rounded-b-md space-y-2"></div>
                    
                        <button id="neighborhood-data-source-btn" class="w-full text-left p-2.5 rounded-t-md font-semibold text-sm bg-gray-800 hover:bg-gray-700 flex justify-between items-center">
                            <span id="nasa-data-source-title-nsi">NASA Data Sources (NSI)</span>
                            <svg id="neighborhood-arrow" class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div id="neighborhood-data-source-content" class="hidden text-sm text-gray-300 bg-gray-900/50 p-3 rounded-b-md space-y-2"></div>

                </div>
            </div>

            <!-- Gemini API Key Section -->
            <div class="mt-auto pt-4 border-t border-white/10">
                <div class="flex justify-between items-center">
                    <p class="text-xs text-gray-500">Version 1.3.8</p>
                    <button id="toggle-api-key-section-btn" class="p-2 rounded-lg hover:bg-gray-700 transition-colors" title="AI Settings">
                        <svg class="w-6 h-6 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    </button>
                </div>
                <div id="api-key-content" class="hidden mt-2">
                        <h3 class="text-md font-semibold text-gray-200 mb-2">Enable AI Features</h3>
                        <p class="text-sm text-gray-400 mb-2">To unlock the AI-powered analysis, please enter your Google Gemini API key below.</p>
                        <div class="flex items-center space-x-2">
                            <input type="password" id="api-key-input" class="w-full bg-gray-900/70 border border-gray-700 rounded-md p-2 text-sm text-white focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Enter your Gemini API Key">
                            <button id="save-api-key-btn" class="bg-indigo-600 hover:bg-indigo-500 text-white font-semibold text-sm px-3 py-2 rounded-md transition-colors">Save</button>
                        </div>
                        <p id="api-key-status" class="text-xs text-green-400 mt-2 hidden">API Key saved successfully!</p>
                </div>
            </div>
        </aside>
        
        <div id="neighborhood-map-view" class="w-full h-full absolute top-0 left-0 pt-48 sm:pt-40 p-4 md:p-8 hidden z-[1000] pointer-events-none">
            <div class="hex-grid"></div>
        </div>

        <div id="menu-overlay" class="fixed inset-0 bg-black/50 z-[1001] hidden pointer-events-auto"></div>

        <div id="city-info-panel" class="absolute top-28 sm:top-0 bottom-24 sm:bottom-0 left-4 sm:left-auto right-4 sm:right-0 w-auto sm:w-full sm:max-w-md h-auto sm:h-full rounded-2xl sm:rounded-none transform translate-x-full transition-transform duration-500 ease-in-out glass-panel z-[1001] overflow-hidden pointer-events-auto"></div>
        <div id="neighborhood-info-panel" class="absolute top-28 sm:top-0 bottom-24 sm:bottom-0 left-4 sm:left-auto right-4 sm:right-0 w-auto sm:w-full sm:max-w-md h-auto sm:h-full rounded-2xl sm:rounded-none transform translate-x-full transition-transform duration-500 ease-in-out glass-panel z-[1001] overflow-hidden pointer-events-auto"></div>
        
        <footer id="legend-and-comparison" class="absolute bottom-0 left-0 w-full p-4 z-[1000] pointer-events-none flex flex-col-reverse items-center space-y-2 space-y-reverse">
            <div id="data-legend" class="w-full max-w-md mx-auto glass-panel rounded-lg p-3 pointer-events-auto"></div>
            <div id="map-layer-switcher" class="pointer-events-auto flex space-x-2"></div>
        </footer>
        
    </div>
    
    <!-- Guide Modal -->
    <div id="guide-modal" class="fixed inset-0 z-[2000] hidden items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
        <div class="w-full max-w-3xl h-full max-h-[90vh] glass-panel rounded-lg shadow-lg flex flex-col">
            <header class="flex items-center justify-between p-4 border-b border-white/10 flex-shrink-0">
                <h2 id="guide-title" class="text-xl font-bold text-white">TerraVitalis Guide</h2>
                <div class="flex items-center space-x-4">
                    <button id="lang-switcher-guide" class="flex items-center space-x-2 glass-panel p-2 rounded-lg hover:bg-gray-700 transition-colors border-indigo-600">
                        <img id="lang-flag-guide" src="https://flagcdn.com/w20/gb.png" alt="Language flag" class="w-5 h-auto rounded-sm">
                        <span id="lang-text-guide" class="font-semibold text-sm">EN</span>
                    </button>
                    <button id="close-guide-modal" class="text-gray-400 hover:text-white text-3xl">&times;</button>
                </div>
            </header>
            <div class="flex-grow p-6 overflow-y-auto text-gray-300 space-y-6 text-sm sm:text-base leading-relaxed">
                <!-- Guide content will be injected here -->
            </div>
        </div>
    </div>

    <!-- Stakeholder Modal -->
    <div id="stakeholder-modal" class="fixed inset-0 z-[2000] hidden items-center justify-center p-4 bg-black/70 backdrop-blur-md">
        <div class="w-full max-w-7xl h-full max-h-[95vh] bg-gray-900/50 border border-white/10 rounded-lg shadow-lg flex flex-col relative glass-panel">
            <header class="flex items-center justify-between p-4 border-b border-white/10 flex-shrink-0">
                <h2 id="stakeholder-title" class="text-xl font-bold text-white">Stakeholder Map</h2>
                <button id="close-stakeholder-modal" class="text-gray-400 hover:text-white text-3xl">&times;</button>
            </header>
            <div class="flex-grow overflow-auto relative">
                <div id="stakeholder-content-wrapper">
                        <div class="map-wrapper">
                            <div class="mindmap-container">
                                <ul class="tree">
                                    <li>
                                        <div class="node root shadow-lg">
                                            <div class="node-header">
                                                <div class="node-icon">
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                                                </div>
                                                <div>
                                                    <h1 class="text-2xl font-extrabold">TerraVitalis Stakeholders</h1>
                                                    <p class="text-sm text-indigo-200">Interactive Relationship & Influence Map</p>
                                                </div>
                                            </div>
                                        </div>
                                        <ul>
                                            <!-- BRANCH: Supra-Municipal & National -->
                                            <li class="has-children">
                                                <div class="node primary stakeholder-node">
                                                    <div class="node-header">
                                                        <div class="node-icon"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 21v-4m0 4v-4m0 4h4m-4 0H7m14-8v-4m0 4v-4m0 4h-4m4 0h-4m-6-4v-4m0 4v-4m0 4H7m4 0h4M3 7v4m0-4v4m0-4h4m-4 0h4m6 0v4m0-4v4m0-4h4m-4 0h-4m2-8a2 2 0 11-4 0 2 2 0 014 0z" /></svg></div>
                                                        <div><h2 class="text-lg font-bold text-indigo-300">Supra-Municipal & National</h2><span class="stakeholder-type">Influencers</span></div>
                                                    </div>
                                                    <div class="toggle-icon">+</div>
                                                </div>
                                                <ul>
                                                    <li><div class="node secondary"><h3 class="font-semibold text-gray-200">National Government</h3><p class="text-sm text-gray-400">Policy alignment, national grants.</p></div></li>
                                                    <li><div class="node secondary"><h3 class="font-semibold text-gray-200">European Union</h3><p class="text-sm text-gray-400">Horizon Europe, LIFE program funding.</p></div></li>
                                                </ul>
                                            </li>
                                            <!-- BRANCH 1: Primary Owner -->
                                            <li class="has-children">
                                                <div class="node primary stakeholder-node">
                                                    <div class="node-header">
                                                        <div class="node-icon"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" /></svg></div>
                                                        <div><h2 class="text-lg font-bold text-indigo-300">Primary Owner (Best Fit)</h2><span class="stakeholder-type">Decision-Maker</span></div>
                                                    </div>
                                                    <div class="node-content text-sm text-gray-300">
                                                        <p class="font-semibold text-white">Dept. of Urban Planning / Green Infrastructure</p>
                                                        <p class="mt-2 opacity-80"><strong class="text-indigo-300">Why:</strong> Owns city-scale land-use, park conversions, and climate adaptation plans.</p>
                                                    </div>
                                                    <div class="toggle-icon">+</div>
                                                </div>
                                            </li>
                                            <!-- BRANCH 2: Executive Sponsors -->
                                            <li class="has-children">
                                                <div class="node primary stakeholder-node">
                                                    <div class="node-header">
                                                        <div class="node-icon"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" /></svg></div>
                                                        <div><h2 class="text-lg font-bold text-indigo-300">Executive Sponsors</h2><span class="stakeholder-type">Decision-Makers</span></div>
                                                    </div>
                                                    <div class="node-content text-sm text-gray-300">
                                                        <p class="font-semibold text-white">Mayor’s Office or Regional Environment Directorate</p>
                                                        <p class="mt-2 opacity-80"><strong class="text-indigo-300">Why:</strong> Links to resilience strategy, funding, and inter-department coordination.</p>
                                                    </div>
                                                    <div class="toggle-icon">+</div>
                                                </div>
                                            </li>
                                            <!-- BRANCH 3: Operational Leads -->
                                            <li class="has-children">
                                                <div class="node primary stakeholder-node">
                                                    <div class="node-header">
                                                        <div class="node-icon"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 4a2 2 0 114 0v1a1 1 0 001 1h3a1 1 0 011 1v3a1 1 0 01-1 1h-1a2 2 0 100 4h1a1 1 0 011 1v3a1 1 0 01-1 1h-3a1 1 0 01-1-1v-1a2 2 0 10-4 0v1a1 1 0 01-1 1H7a1 1 0 01-1-1v-3a1 1 0 00-1-1H4a2 2 0 110-4h1a1 1 0 001-1V7a1 1 0 011-1h3a1 1 0 001-1V4z" /></svg></div>
                                                        <div><h2 class="text-lg font-bold text-indigo-300">Operational Leads (Must Have)</h2><span class="stakeholder-type">Implementers</span></div>
                                                    </div>
                                                    <div class="toggle-icon">+</div>
                                                </div>
                                                <ul>
                                                    <li><div class="node secondary stakeholder-node"><h3 class="font-semibold text-gray-200">Parks, Gardens & Forestry</h3><div class="node-content text-sm text-gray-400"><p>Executes park conversions and micro-orchards.</p><div class="engagement-level"><div class="engagement-bar" style="width: 90%;"></div></div></div><div class="toggle-icon">+</div></div></li>
                                                    <li><div class="node secondary stakeholder-node"><h3 class="font-semibold text-gray-200">Public Health / Heatwave Office</h3><div class="node-content text-sm text-gray-400"><p>Links heat data to health interventions.</p><div class="engagement-level"><div class="engagement-bar" style="width: 75%;"></div></div></div><div class="toggle-icon">+</div></div></li>
                                                    <li><div class="node secondary stakeholder-node"><h3 class="font-semibold text-gray-200">Social Services & Food Aid</h3><div class="node-content text-sm text-gray-400"><p>(e.g., Caritas, Food Banks) – Manages distribution & community stewardship.</p><div class="engagement-level"><div class="engagement-bar" style="width: 60%;"></div></div></div><div class="toggle-icon">+</div></div></li>
                                                    <li><div class="node secondary stakeholder-node"><h3 class="font-semibold text-gray-200">GIS/Open Data Office</h3><div class="node-content text-sm text-gray-400"><p>Ensures reproducible data pipelines & dashboards.</p><div class="engagement-level"><div class="engagement-bar" style="width: 85%;"></div></div></div><div class="toggle-icon">+</div></div></li>
                                                </ul>
                                            </li>
                                            <!-- BRANCH 4: Community Partners -->
                                            <li class="has-children">
                                                <div class="node primary stakeholder-node">
                                                    <div class="node-header">
                                                        <div class="node-icon"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M15 21v-1a6 6 0 00-9-5.197m0 0A12.015 12.015 0 0112 13c2.25 0 4.31.865 5.898 2.256M15 21h3v-1a6 6 0 00-6-6M15 21v-1a6 6 0 00-6-6m0 0v-1a2 2 0 10-4 0v1m0 0v1a2 2 0 104 0v-1m0-9.458a4 4 0 11-8 0 4 4 0 018 0z" /></svg></div>
                                                        <div><h2 class="text-lg font-bold text-indigo-300">Community Partners</h2><span class="stakeholder-type">Collaborators</span></div>
                                                    </div>
                                                    <div class="toggle-icon">+</div>
                                                </div>
                                                <ul>
                                                    <li><div class="node secondary"><h3 class="font-semibold text-gray-200">Parishes, shelters, schools</h3><p class="text-sm text-gray-400">Volunteer rotas, care-pacts.</p></div></li>
                                                    <li><div class="node secondary"><h3 class="font-semibold text-gray-200">Universities/Tech schools</h3><p class="text-sm text-gray-400">Student crews for monitoring.</p></div></li>
                                                    <li><div class="node secondary"><h3 class="font-semibold text-gray-200">Local NGOs</h3><p class="text-sm text-gray-400">Urban ag, biodiversity, circular economy.</p></div></li>
                                                </ul>
                                            </li>
                                            <!-- BRANCH 5: External Enablers -->
                                            <li class="has-children">
                                                <div class="node primary stakeholder-node">
                                                    <div class="node-header">
                                                        <div class="node-icon"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg></div>
                                                        <div><h2 class="text-lg font-bold text-indigo-300">External Enablers</h2><span class="stakeholder-type">Supporters</span></div>
                                                    </div>
                                                    <div class="toggle-icon">+</div>
                                                </div>
                                                <ul>
                                                    <li><div class="node tertiary"><p class="font-semibold text-gray-300">Water utility (irrigation)</p></div></li>
                                                    <li><div class="node tertiary"><p class="font-semibold text-gray-300">Transit agency (wayfinding)</p></div></li>
                                                    <li><div class="node tertiary"><p class="font-semibold text-gray-300">CSR sponsors (tools, seedlings)</p></div></li>
                                                    <li><div class="node tertiary"><p class="font-semibold text-gray-300">Foundations (seed grants)</p></div></li>
                                                </ul>
                                            </li>
                                        </ul>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <script>
                            // This script is scoped to the stakeholder modal content
                            (function() {
                                const stakeholderWrapper = document.getElementById('stakeholder-content-wrapper');
                                if (!stakeholderWrapper) return;

                                const allBranchItems = stakeholderWrapper.querySelectorAll('.has-children');
                                const allContentNodes = stakeholderWrapper.querySelectorAll('.stakeholder-node');

                                const toggleNode = (element, expand) => {
                                    if (expand) {
                                        element.classList.add('expanded');
                                    } else {
                                        element.classList.remove('expanded');
                                    }
                                };

                                stakeholderWrapper.querySelectorAll('.node').forEach(node => {
                                    node.addEventListener('click', function (event) {
                                        event.stopPropagation();
                                        const parentLi = this.parentElement;
                                        if (parentLi.classList.contains('has-children')) {
                                            toggleNode(parentLi, !parentLi.classList.contains('expanded'));
                                        }
                                        if (this.classList.contains('stakeholder-node')) {
                                            toggleNode(this, !this.classList.contains('expanded'));
                                        }
                                    });
                                });
                                
                                const root = stakeholderWrapper.querySelector('.tree > li');
                                if (root) {
                                    toggleNode(root, true);
                                    root.querySelectorAll(':scope > ul > li.has-children').forEach(li => toggleNode(li, true));
                                }
                            })();
                        </script>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let map;
            let cityMarkers = [];
            let currentMapLayer = null;
            let currentLanguage = 'en';
            let currentNeighborhoodLayer = 'nsi';
            // This default API key is provided for demonstration purposes.
            // For production, it's crucial to manage API keys securely on a server-side environment.
            // Storing keys on the client-side is a security risk.
            const defaultApiKey = 'AIzaSyDCEGX3-vgvEteg7jx_eiKv0-a09dindZk';

            const translations = {
                en: {
                    guide: "Guide",
                    stakeholders: "Stakeholders",
                    stakeholderMapTitle: "Stakeholder Map",
                    guideTitle: "TerraVitalis Guide",
                    selectCityTitle: "Select City",
                    disclaimerTitle: "Disclaimer:",
                    disclaimerText: "This is a prototype for the NASA Space Apps Challenge. Data is illustrative, not connected to live NASA sources, and may be incorrect.",
                    guideContent: `
                        <p>TerraVitalis is a decision-support platform that uses NASA Earth observation and an AI copilot to help cities identify problems and risk areas and to suggest plausible benefits of targeted green projects.</p>
                        <p class="mt-4">It does not plant trees or enforce policy; it guides planners and communities to act where green space can become more edible, equitable, and cooling—via two indices: <strong>CECR (City Edible Conversion Readiness)</strong> and <strong>NSI (Neighborhood NutriShade Index)</strong>.</p>
                        
                        <h3 class="mt-6 text-lg font-semibold text-indigo-400">The Two Urban Challenges We Help Address</h3>
                        <h4 class="mt-4 text-md font-semibold text-white">Underused Green in Big Cities (CECR track)</h4>
                        <p>Many cities have substantial parkland that is non-productive and often concentrated in wealthier districts. TerraVitalis highlights where converting ~10% of suitable park areas into community-stewarded orchards and vegetable gardens could:</p>
                        <ul class="list-disc list-inside space-y-2 pl-4 mt-2">
                            <li>expand local, dignified food access (generating food for people in need, in 2024, 8.5% of the EU population were unable to afford a proper meal),</li>
                            <li>strengthen social cohesion (care-pacts, volunteer rotas),</li>
                            <li>support a circular economy (on-site composting, local distribution),</li>
                            <li>while preserving recreation and enhancing biodiversity.</li>
                        </ul>

                        <h4 class="mt-4 text-md font-semibold text-white">Green Deserts & Heat Inequality (NSI track)</h4>
                        <p>Large portions of cities are far from usable green and outside recommended distances, amplifying urban heat and inequality. Heat is a growing health threat; global tracking shows a sharp rise in heat-related risks, with particularly high burdens among older adults and other vulnerable groups. In Europe alone, 47,690 heat-related deaths were estimated for 2023 (second only to 2022). The World Heath Organization recommends proximal access to public green ≥0.5–1 ha within 300 m. TerraVitalis pinpoints high-need, high-heat, high-population areas and proposes micro-orchards (small, street-adjacent fruit plantings) that local communities can steward to cool daily routes (schools/clinics/transit) and provide fresh food where it’s needed most.</p>

                        <h3 class="mt-6 text-lg font-semibold text-indigo-400">How It Works — A Two-Scale Approach</h3>
                        <p>TerraVitalis operates on two connected levels. We start high to choose where to begin, then zoom in to choose where exactly to act.</p>

                        <h4 class="mt-4 text-md font-semibold text-white">Scale 1 — City Readiness View (“Where to start?”)</h4>
                        <p><strong>Purpose:</strong> Help policymakers and organizations decide which cities are most ready for high-impact edible-greening initiatives.</p>
                        <div class="mt-2"><strong>What you’re seeing</strong></div>
                        <ul class="list-disc list-inside space-y-1 pl-4 mt-1">
                            <li>A regional map (e.g., Europe) with cities as circles.</li>
                            <li>Circle size = total existing green base.</li>
                            <li>Circle color = overall readiness (CECR)—warmer colors = higher readiness/need.</li>
                        </ul>
                        <div class="mt-2"><strong>The core metric — CECR (City Edible Conversion Readiness)</strong></div>
                        <p>A single score indicating how primed a city is for edible conversion, derived largely from NASA-aligned data:</p>
                        <ul class="list-disc list-inside space-y-1 pl-4 mt-1">
                            <li><strong>Poverty Need (PN):</strong> where help is most needed (food insecurity/deprivation).</li>
                            <li><strong>Heat/Health Priority (HP):</strong> ECOSTRESS thermal data → severe urban heat islands.</li>
                            <li><strong>Accessibility Bonus (AB):</strong> whether existing green can serve vulnerable groups (≤600 m to shelters, schools, public housing, parishes).</li>
                            <li><strong>Green Base (GB):</strong> MODIS vegetation/land-cover baseline.</li>
                        </ul>
                        <div class="mt-2"><strong>AI functionality</strong></div>
                        <ul class="list-disc list-inside space-y-1 pl-4 mt-1">
                            <li><strong>Explain:</strong> Plain-language summaries of why a city scored as it did (with data lineage to layers/years).</li>
                            <li><strong>Recommend:</strong> Climate-fit crop/orchard mixes and phenology windows with range-based yield estimates and assumptions noted.</li>
                        </ul>

                        <h4 class="mt-4 text-md font-semibold text-white">Scale 2 — Neighborhood Priority View (“Where exactly?”)</h4>
                        <p><strong>Purpose:</strong> Identify specific neighborhoods (≈1 km²) where micro-interventions—community gardens, micro-orchards, green roofs—could deliver the greatest human and environmental benefit.</p>
                        <div class="mt-2"><strong>What you’re seeing</strong></div>
                        <ul class="list-disc list-inside space-y-1 pl-4 mt-1">
                            <li>The map switches to a hexagonal grid over the selected city.</li>
                            <li>Each hex ≈ 1 km²; hex color shows priority based on NSI.</li>
                        </ul>
                        <div class="mt-2"><strong>The core metric — NSI (NutriShade Index)</strong></div>
                        <p>Reveals “green deserts” where small projects yield outsized impact:</p>
                        <ul class="list-disc list-inside space-y-1 pl-4 mt-1">
                            <li><strong>Green Access Deficit (GAD):</strong> distance to a usable park (e.g., ≥1 ha within 300 m).</li>
                            <li><strong>Heat Burden (HB):</strong> local ECOSTRESS surface-temperature percentile (summer).</li>
                            <li><strong>Density Boost (DB):</strong> how many people benefit (GPWv4/WorldPop).</li>
                        </ul>
                        <div class="mt-2"><strong>AI functionality</strong></div>
                        <ul class="list-disc list-inside space-y-1 pl-4 mt-1">
                            <li><strong>Interpret:</strong> Explains why a hex is high-priority (cites the layers & thresholds used).</li>
                            <li><strong>Micro-plans:</strong> Suggests concept layouts (beds/orchard rows), species mix tuned to local climate, and staggered harvest schedules.</li>
                            <li><strong>Forecast:</strong> Outputs benefit ranges (kg/portions, °C cooling proxies, pollinator habitat indicators) with uncertainty bands and data caveats.</li>
                        </ul>
                    `,
                    guideMenu: "App Guide",
                    stakeholdersMenu: "Stakeholder Map",
                    cecrViewMenu: "City View (CECR)",
                    nsiViewMenu: "Neighborhood View (NSI)",
                    cityReadiness: "City Readiness (CECR)",
                    cityReadinessShort: "City",
                    neighborhoodPriority: "Neighborhood Priority (NSI)",
                    neighborhoodPriorityShort: "Neighborhood",
                    cityRankingsTitle: "City Edible Conversion Readiness(CECR)",
                    cityRankingsSubtitle: "Higher CECR scores indicate greater readiness for projects.",
                    neighborhoodAnalysisTitle: "Neighborhood NutriShade Index (NSI)",
                    neighborhoodAnalysisSubtitle: "Toggle data overlays to understand the NutriShade Index (NSI) composition.",
                    nsiHeatmap: "NSI Priority Heatmap",
                    heatBurden: "Heat Burden (LST)",
                    greenAccessDeficit: "Green Access Deficit",
                    populationDensity: "Population Density",
                    dataOverlays: "Data Layers",
                    cecrFormulaTitle: "CECR (City Edible Conversion Readiness) Formula",
                    cecrCalcTitle: "CECR Calculation",
                    povertyNeed: "PN (Poverty Need)",
                    accessibilityBonus: "AB (Accessibility Bonus)",
                    heatHealthPriority: "HP (Heat/Health Priority)",
                    greenBase: "GB (Green Base)",
                    projectedImpact: "Projected Impact",
                    estFoodProduction: "Est. Food Production",
                    foodRations: "Equivalent Food Rations",
                    portionsYear: "portions/year",
                    basedOnPortion: "(Based on 0.5 kg per portion)",
                    tonnesYear: "tonnes/year",
                    microOrchardEstDim: "🌳 Micro-orchard Est. Dimension",
                    tenPercentGreenSpace: "(10% of total green space)",
                    potentialImpact: "Potential Impact",
                    estConvertibleArea: "🌳 Est. Convertible Area",
                    onePercentCellArea: "(Based on 1% of cell area)",
                    analyzeGreenSpaces: "🌳 Benefits & Circular Economy",
                    dataInterpretation: "✨ Data Interpretation",
                    drillDown: "🔬 Drill Down to Neighborhoods",
                    nsiFormulaTitle: "NSI (NutriShade Index) Formula",
                    nsiCalcTitle: "NSI Breakdown",
                    gad: "GAD (Green Access Deficit)",
                    hb: "HB (Heat Burden)",
                    db: "DB (Density Boost)",
                    groundTruth: "Ground-Truth Data",
                    contextualData: "Contextual Data",
                    city: "City",
                    avgSummerTemp: "Avg. Summer Temp",
                    estCellPopulation: "Est. Cell Population",
                    analyzePotential: "✨ Benefits & Circular Economy",
                    enableAIFeatures: "Enable AI Features",
                    enterApiKey: "To unlock the AI-powered analysis, please enter your Google Gemini API key below.",
                    save: "Save",
                    apiKeySaved: "API Key saved successfully!",
                    lowReadiness: "Low Readiness",
                    highReadiness: "High Readiness",
                    cecrScore: "CECR Score",
                    lowPriority: "Low Priority",
                    highPriority: "High Priority",
                    nsiScore: "NSI Score",
                    nasaDataSourceTitleCECR: "NASA Data Sources (CECR)",
                    nasaDataSourceContentCECR: `<p><strong>GPWv4:</strong> Population density data. <span class='text-green-400 font-semibold'>(integrated)</span></p><p><strong>SEDAC Poverty Datasets:</strong> Global deprivation and poverty maps to inform the Poverty Need (PN) score. <span class='text-red-400 font-semibold'>(simulated)</span></p><p><strong>ECOSTRESS LST:</strong> High-resolution (70m) thermal data to identify urban heat islands and calculate the Heat Priority (HP) score. <span class='text-red-400 font-semibold'>(simulated)</span></p><p><strong>MODIS Vegetation Indices:</strong> Measures current greenness to identify parks suitable for conversion. <span class='text-red-400 font-semibold'>(simulated)</span></p><p><strong>Partner Data (e.g., OSM):</strong> Provides park boundaries and community facility locations to calculate the Accessibility Bonus (AB). <span class='text-red-400 font-semibold'>(simulated)</span></p>`,
                    nasaDataSourceTitleNSI: "NASA Data Sources (NSI)",
                    nasaDataSourceContentNSI: `<p><strong>MODIS Vegetation Indices (NDVI/EVI):</strong> Maps vegetation scarcity and density at a local level. <span class='text-red-400 font-semibold'>(simulated)</span></p><p><strong>ECOSTRESS LST:</strong> Pinpoints neighborhood-level heat hotspots with high-resolution (70m) temperature data. <span class='text-red-400 font-semibold'>(simulated)</span></p><p><strong>GPWv4 Population Grid:</strong> Provides population counts (~1km) to weight the NSI and prioritize densely populated areas. <span class='text-green-400 font-semibold'>(integrated)</span></p><p><strong>GRDIv1 & Poverty Maps:</strong> Optional layers to further prioritize interventions in socially and economically deprived areas. <span class='text-red-400 font-semibold'>(simulated)</span></p>`,
                    toolScopeCECRTitle: "Tool Scope (CECR)",
                    toolScopeCECRContent: `<p>This view helps identify and rank cities based on their readiness for large-scale urban greening projects. The <strong>CECR score</strong> synthesizes social need (poverty), climate vulnerability (heat), and logistical potential (green space availability and accessibility) to guide strategic investment decisions.</p>`,
                    toolScopeNSITitle: "Tool Scope (NSI)",
                    toolScopeNSIContent: `<p>This view drills down into a selected city to identify high-priority neighborhoods for micro-interventions. The <strong>NSI score</strong> pinpoints specific areas (approx. 1km²) that suffer from a combination of high urban heat, poor access to existing parks, and high population density, making them ideal candidates for new micro-orchards.</p>`,
                    estSummerCooling: "Est. Summer Cooling",
                    peakTempReduction: "Peak temp. reduction",
                    potentialBeneficiaries: "Potential Beneficiaries",
                    inThisNeighborhood: "In this neighborhood",
                    estPeopleSustained: "Est. People Sustained",
                    sustainedDaily: "Sustained daily"
                },
                it: {
                    guide: "Guida",
                    stakeholders: "Stakeholder",
                    stakeholderMapTitle: "Mappa degli Stakeholder",
                    guideTitle: "Guida di TerraVitalis",
                    selectCityTitle: "Seleziona Città",
                    disclaimerTitle: "Avvertenza:",
                    disclaimerText: "Questo è un prototipo per la NASA Space Apps Challenge. I dati sono illustrativi, non collegati a fonti dati NASA in tempo reale e potrebbero essere errati.",
                    guideContent: `
                        <p>TerraVitalis è una piattaforma di supporto decisionale che utilizza l'osservazione della Terra della NASA e un copilota AI per aiutare le città a identificare problemi e aree di rischio e per suggerire i benefici plausibili di progetti ecologici mirati.</p>
                        <p class="mt-4">Non pianta alberi né impone politiche; guida pianificatori e comunità ad agire dove lo spazio verde può diventare più commestibile, equo e rinfrescante, tramite due indici: <strong>CECR (Prontezza alla Conversione Edibile delle Città)</strong> e <strong>NSI (Indice NutriShade di Quartiere)</strong>.</p>
                        
                        <h3 class="mt-6 text-lg font-semibold text-indigo-400">Le Due Sfide Urbane che Aiutiamo ad Affrontare</h3>
                        <h4 class="mt-4 text-md font-semibold text-white">Verde Sottoutilizzato nelle Grandi Città (Traccia CECR)</h4>
                        <p>Molte città hanno considerevoli aree verdi non produttive e spesso concentrate nei quartieri più ricchi. TerraVitalis evidenzia dove la conversione di circa il 10% delle aree verdi idonee in frutteti e orti gestiti dalla comunità potrebbe:</p>
                        <ul class="list-disc list-inside space-y-2 pl-4 mt-2">
                            <li>espandere l'accesso locale e dignitoso al cibo (generando cibo per le persone bisognose, nel 2024, l'8,5% della popolazione dell'UE non poteva permettersi un pasto adeguato),</li>
                            <li>rafforzare la coesione sociale (patti di cura, turni di volontariato),</li>
                            <li>sostenere un'economia circolare (compostaggio in loco, distribuzione locale),</li>
                            <li>preservando al contempo le attività ricreative e migliorando la biodiversità.</li>
                        </ul>

                        <h4 class="mt-4 text-md font-semibold text-white">Deserti Verdi e Disuguaglianza Termica (Traccia NSI)</h4>
                        <p>Grandi porzioni di città sono lontane da spazi verdi utilizzabili e al di fuori delle distanze raccomandate, amplificando il calore urbano e la disuguaglianza. Il caldo è una minaccia crescente per la salute; il monitoraggio globale mostra un forte aumento dei rischi legati al calore, con oneri particolarmente elevati tra gli anziani e altri gruppi vulnerabili. Solo in Europa, per il 2023 sono stati stimati 47,690 decessi legati al calore (secondo solo al 2022). L'Organizzazione Mondiale della Sanità raccomanda un accesso prossimo a spazi verdi pubblici ≥0,5–1 ha entro 300 m. TerraVitalis individua aree ad alta necessità, alto calore e alta densità di popolazione e propone micro-frutteti (piccole piantagioni di frutta adiacenti alle strade) che le comunità locali possono gestire per rinfrescare i percorsi quotidiani (scuole/cliniche/trasporti) e fornire cibo fresco dove è più necessario.</p>

                        <h3 class="mt-6 text-lg font-semibold text-indigo-400">Come Funziona — Un Approccio su Due Scale</h3>
                        <p>TerraVitalis opera su due livelli connessi. Partiamo dall'alto per scegliere da dove iniziare, poi ci avviciniamo per decidere dove agire esattamente.</p>

                        <h4 class="mt-4 text-md font-semibold text-white">Scala 1 — Vista Prontezza Città (“Da dove iniziare?”)</h4>
                        <p><strong>Scopo:</strong> Aiutare i decisori politici e le organizzazioni a decidere quali città sono più pronte per iniziative di inverdimento commestibile ad alto impatto.</p>
                        <div class="mt-2"><strong>Cosa stai vedendo</strong></div>
                        <ul class="list-disc list-inside space-y-1 pl-4 mt-1">
                            <li>Una mappa regionale (es. Europa) con le città rappresentate da cerchi.</li>
                            <li>Dimensione del cerchio = base verde totale esistente.</li>
                            <li>Colore del cerchio = prontezza generale (CECR)—colori più caldi = maggiore prontezza/necessità.</li>
                        </ul>
                        <div class="mt-2"><strong>La metrica principale — CECR (Prontezza alla Conversione Edibile delle Città)</strong></div>
                        <p>Un singolo punteggio che indica quanto una città è pronta per la conversione commestibile, derivato in gran parte da dati allineati con la NASA:</p>
                        <ul class="list-disc list-inside space-y-1 pl-4 mt-1">
                            <li><strong>Necessità di Povertà (PN):</strong> dove l'aiuto è più necessario (insicurezza alimentare/deprivazione).</li>
                            <li><strong>Priorità Calore/Salute (HP):</strong> dati termici ECOSTRESS → gravi isole di calore urbane.</li>
                            <li><strong>Bonus Accessibilità (AB):</strong> se il verde esistente può servire gruppi vulnerabili (≤600 m da rifugi, scuole, alloggi pubblici, parrocchie).</li>
                            <li><strong>Base Verde (GB):</strong> baseline di vegetazione/copertura del suolo MODIS.</li>
                        </ul>
                        <div class="mt-2"><strong>Funzionalità AI</strong></div>
                        <ul class="list-disc list-inside space-y-1 pl-4 mt-1">
                            <li><strong>Spiega:</strong> Riepiloghi in linguaggio semplice del perché una città ha ottenuto un certo punteggio (con tracciabilità dei dati a layer/anni).</li>
                            <li><strong>Raccomanda:</strong> Mix di colture/frutteti adatti al clima e finestre fenologiche con stime di rendimento basate su intervalli e ipotesi annotate.</li>
                        </ul>

                        <h4 class="mt-4 text-md font-semibold text-white">Scala 2 — Vista Priorità di Quartiere (“Dove esattamente?”)</h4>
                        <p><strong>Scopo:</strong> Identificare quartieri specifici (≈1 km²) dove micro-interventi—orti comunitari, micro-frutteti, tetti verdi—potrebbero fornire il massimo beneficio umano e ambientale.</p>
                        <div class="mt-2"><strong>Cosa stai vedendo</strong></div>
                        <ul class="list-disc list-inside space-y-1 pl-4 mt-1">
                            <li>La mappa passa a una griglia esagonale sulla città selezionata.</li>
                            <li>Ogni esagono ≈ 1 km²; il colore dell'esagono mostra la priorità basata sull'NSI.</li>
                        </ul>
                        <div class="mt-2"><strong>La metrica principale — NSI (Indice NutriShade)</strong></div>
                        <p>Rivela “deserti verdi” dove piccoli progetti producono un impatto sproporzionato:</p>
                        <ul class="list-disc list-inside space-y-1 pl-4 mt-1">
                            <li><strong>Deficit di Accesso al Verde (GAD):</strong> distanza da un parco utilizzabile (es. ≥1 ha entro 300 m).</li>
                            <li><strong>Carico di Calore (HB):</strong> percentile della temperatura superficiale locale ECOSTRESS (estate).</li>
                            <li><strong>Aumento per Densità (DB):</strong> quante persone ne beneficiano (GPWv4/WorldPop).</li>
                        </ul>
                        <div class="mt-2"><strong>Funzionalità AI</strong></div>
                        <ul class="list-disc list-inside space-y-1 pl-4 mt-1">
                            <li><strong>Interpreta:</strong> Spiega perché un esagono è ad alta priorità (cita i layer e le soglie utilizzate).</li>
                            <li><strong>Micro-piani:</strong> Suggerisce layout concettuali (aiuole/filari di frutteto), mix di specie adattate al clima locale e calendari di raccolta sfalsati.</li>
                            <li><strong>Previsione:</strong> Fornisce intervalli di benefici (kg/porzioni, proxy di raffreddamento in °C, indicatori di habitat per impollinatori) con fasce di incertezza e avvertenze sui dati.</li>
                        </ul>
                    `,
                    guideMenu: "Guida Applicazione",
                    stakeholdersMenu: "Mappa Stakeholder",
                    cecrViewMenu: "Vista Città (CECR)",
                    nsiViewMenu: "Vista Quartiere (NSI)",
                    cityReadiness: "Prontezza Città (CECR)",
                    cityReadinessShort: "Città",
                    neighborhoodPriority: "Priorità Quartiere (NSI)",
                    neighborhoodPriorityShort: "Quartiere",
                    cityRankingsTitle: "Readiness Conversione Edibile Città (CECR)",
                    cityRankingsSubtitle: "Punteggi CECR più alti indicano una maggiore prontezza per i progetti.",
                    neighborhoodAnalysisTitle: "Indice NutriShade di Quartiere (NSI)",
                    neighborhoodAnalysisSubtitle: "Attiva/disattiva i layer di dati per comprendere la composizione dell'Indice NutriShade (NSI).",
                    nsiHeatmap: "Mappa di Priorità NSI",
                    heatBurden: "Carico di Calore (LST)",
                    greenAccessDeficit: "Deficit di Accesso al Verde",
                    populationDensity: "Densità di Popolazione",
                    dataOverlays: "Layer Dati",
                    cecrFormulaTitle: "Formula CECR (Prontezza alla Conversione Edibile delle Città)",
                    cecrCalcTitle: "Calcolo CECR",
                    povertyNeed: "PN (Necessità di Povertà)",
                    accessibilityBonus: "AB (Bonus Accessibilità)",
                    heatHealthPriority: "HP (Priorità Calore/Salute)",
                    greenBase: "GB (Base Verde)",
                    projectedImpact: "Impatto Proiettato",
                    estFoodProduction: "Produzione Alimentare Stimata",
                    foodRations: "Razioni Alimentari Equivalenti",
                    portionsYear: "porzioni/anno",
                    basedOnPortion: "(Basato su 0.5 kg per porzione)",
                    tonnesYear: "tonnellate/anno",
                    microOrchardEstDim: "🌳 Dimensione Stimata Micro-frutteto",
                    tenPercentGreenSpace: "(10% dello spazio verde totale)",
                    potentialImpact: "Impatto Potenziale",
                    estConvertibleArea: "🌳 Area Convertibile Stimata",
                    onePercentCellArea: "(Basato sull'1% dell'area della cella)",
                    analyzeGreenSpaces: "🌳 Analizza Benefici",
                    dataInterpretation: "✨ Interpretazione Dati",
                    drillDown: "🔬 Analisi di Quartiere",
                    nsiFormulaTitle: "Formula NSI (Indice NutriShade)",
                    nsiCalcTitle: "Analisi NSI",
                    gad: "GAD (Deficit Accesso Verde)",
                    hb: "HB (Carico di Calore)",
                    db: "DB (Incremento Densità)",
                    groundTruth: "Dati sul Campo",
                    contextualData: "Dati Contestuali",
                    city: "Città",
                    avgSummerTemp: "Temp. Media Estiva",
                    estCellPopulation: "Pop. Stimata Cella",
                    analyzePotential: "✨ Benefici Potenziali",
                    enableAIFeatures: "Abilita Funzionalità IA",
                    enterApiKey: "Per sbloccare l'analisi basata su IA, inserisci la tua chiave API di Google Gemini qui sotto.",
                    save: "Salva",
                    apiKeySaved: "Chiave API salvata con successo!",
                    lowReadiness: "Bassa Prontezza",
                    highReadiness: "Alta Prontezza",
                    cecrScore: "Punteggio CECR",
                    lowPriority: "Bassa Priorità",
                    highPriority: "Alta Priorità",
                    nsiScore: "Punteggio NSI",
                    nasaDataSourceTitleCECR: "Fonti Dati NASA (CECR)",
                    nasaDataSourceContentCECR: `<p><strong>GPWv4:</strong> Dati sulla densità di popolazione. <span class='text-green-400 font-semibold'>(integrato)</span></p><p><strong>SEDAC Poverty Datasets:</strong> Mappe globali di deprivazione e povertà per informare il punteggio di Necessità di Povertà (PN). <span class='text-red-400 font-semibold'>(simulato)</span></p><p><strong>ECOSTRESS LST:</strong> Dati termici ad alta risoluzione (70m) per identificare le isole di calore urbane e calcolare il punteggio di Priorità Calore (HP). <span class='text-red-400 font-semibold'>(simulato)</span></p><p><strong>MODIS Vegetation Indices:</strong> Misura il livello di vegetazione attuale per identificare parchi adatti alla conversione. <span class='text-red-400 font-semibold'>(simulato)</span></p><p><strong>Dati Partner (es. OSM):</strong> Fornisce confini dei parchi e posizioni di strutture comunitarie per calcolare il Bonus Accessibilità (AB). <span class='text-red-400 font-semibold'>(simulato)</span></p>`,
                    nasaDataSourceTitleNSI: "Fonti Dati NASA (NSI)",
                    nasaDataSourceContentNSI: `<p><strong>MODIS Vegetation Indices (NDVI/EVI):</strong> Mappa la scarsità e la densità della vegetazione a livello locale. <span class='text-red-400 font-semibold'>(simulato)</span></p><p><strong>ECOSTRESS LST:</strong> Individua punti caldi a livello di quartiere con dati di temperatura ad alta risoluzione (70m). <span class='text-red-400 font-semibold'>(simulato)</span></p><p><strong>GPWv4 Population Grid:</strong> Fornisce conteggi della popolazione (~1km) per pesare l'NSI e dare priorità alle aree densamente popolate. <span class='text-green-400 font-semibold'>(integrato)</span></p><p><strong>GRDIv1 & Mappe di Povertà:</strong> Layer opzionali per dare ulteriore priorità a interventi in aree socialmente ed economicamente svantaggiate. <span class='text-red-400 font-semibold'>(simulato)</span></p>`,
                    toolScopeCECRTitle: "Scopo dello Strumento (CECR)",
                    toolScopeCECRContent: `<p>Questa vista aiuta a identificare e classificare le città in base alla loro prontezza per progetti di inverdimento urbano su larga scala. Il <strong>punteggio CECR</strong> sintetizza il bisogno sociale (povertà), la vulnerabilità climatica (calore) e il potenziale logistico (disponibilità e accessibilità degli spazi verdi) per guidare le decisioni di investimento strategico.</p>`,
                    toolScopeNSITitle: "Scopo dello Strumento (NSI)",
                    toolScopeNSIContent: `<p>Questa vista analizza in dettaglio una città selezionata per identificare i quartieri ad alta priorità per micro-interventi. Il <strong>punteggio NSI</strong> individua aree specifiche (circa 1km²) che soffrono di una combinazione di elevato calore urbano, scarso accesso ai parchi esistenti e alta densità di popolazione, rendendole candidate ideali per nuovi micro-frutteti.</p>`,
                    estSummerCooling: "Raffrescamento Estivo Stim.",
                    peakTempReduction: "Riduzione temp. massima",
                    potentialBeneficiaries: "Potenziali Beneficiari",
                    inThisNeighborhood: "In questo quartiere",
                    estPeopleSustained: "Persone Sostenute St.",
                    sustainedDaily: "Sostenute giornalmente"
                }
            };
            
            const mapLayers = {
                dark: { name: 'Dark Matter', name_it: 'Materia Oscura', url: 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', options: { attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>' } },
                satellite: { name: 'Satellite', name_it: 'Satellite', url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', options: { attribution: 'Tiles &copy; Esri' } },
                streets: { name: 'Streets', name_it: 'Strade', url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', options: { attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors' } }
            };

            // This consolidated data structure can be loaded from an external file or API endpoint.
            const consolidatedAppData = {
              "cities": [
                {
                  "id": "new-york",
                  "name": "New York",
                  "name_it": "New York",
                  "pn_z": 1.1, "ab_z": -0.1, "hp_z": 1.3, "gb_z": 0.8,
                  "green_ha": 12000, "lat": 40.7128, "lng": -74.0060, "avgSummerC": 29, "population": 8400000,
                  "cecr_score": 0.75,
                  "neighborhood_cells": Array.from({ length: 80 }, (_, i) => ({ "id": `new-york-cell-${i}`, "nsi_score": (Math.random() + 0.4) * 1.4, "gad_z": Math.random() * 1.8 - 0.2, "hb_z": Math.random() * 2.2 - 0.1, "db_z": Math.random() * 2.8, "population": 105000 + Math.floor(Math.random() * 30000) }))
                },
                {
                  "id": "washington-dc",
                  "name": "Washington D.C.",
                  "name_it": "Washington D.C.",
                  "pn_z": 0.8, "ab_z": 0.6, "hp_z": 1.5, "gb_z": 1.0,
                  "green_ha": 3000, "lat": 38.9072, "lng": -77.0369, "avgSummerC": 31, "population": 700000,
                  "cecr_score": 0.90,
                  "neighborhood_cells": Array.from({ length: 80 }, (_, i) => ({ "id": `washington-dc-cell-${i}`, "nsi_score": (Math.random() + 0.5) * 1.5, "gad_z": Math.random() * 1.9, "hb_z": Math.random() * 2.4, "db_z": Math.random() * 1.5, "population": 8750 + Math.floor(Math.random() * 2000) }))
                },
                {
                  "id": "london",
                  "name": "London",
                  "name_it": "Londra",
                  "pn_z": 0.3, "ab_z": 0.4, "hp_z": 0.6, "gb_z": 0.7,
                  "green_ha": 3500, "lat": 51.5072, "lng": -0.1276, "avgSummerC": 23, "population": 9000000,
                  "cecr_score": 0.45,
                  "neighborhood_cells": Array.from({ length: 80 }, (_, i) => ({ "id": `london-cell-${i}`, "nsi_score": (Math.random() + 0.1) * 0.9, "gad_z": Math.random() * 1.5 - 0.5, "hb_z": Math.random() * 1.4 - 0.4, "db_z": Math.random() * 2 - 1, "population": 110000 + Math.floor(Math.random() * 20000) }))
                },
                {
                  "id": "paris",
                  "name": "Paris",
                  "name_it": "Parigi",
                  "pn_z": 0.4, "ab_z": 0.2, "hp_z": 0.9, "gb_z": -1.0,
                  "green_ha": 2200, "lat": 48.8566, "lng": 2.3522, "avgSummerC": 25, "population": 2141000,
                  "cecr_score": 0.3,
                  "neighborhood_cells": Array.from({ length: 80 }, (_, i) => ({ "id": `paris-cell-${i}`, "nsi_score": (Math.random() + 0.2) * 1.1, "gad_z": Math.random() * 1.6 - 0.4, "hb_z": Math.random() * 1.8 - 0.2, "db_z": Math.random() * 2.2 - 0.8, "population": 25000 + Math.floor(Math.random() * 10000) }))
                },
                {
                  "id": "berlin",
                  "name": "Berlin",
                  "name_it": "Berlino",
                  "pn_z": 0.5, "ab_z": 0.7, "hp_z": 0.5, "gb_z": 1.2,
                  "green_ha": 3000, "lat": 52.52, "lng": 13.405, "avgSummerC": 24, "population": 3645000,
                  "cecr_score": 0.63,
                  "neighborhood_cells": Array.from({ length: 80 }, (_, i) => ({ "id": `berlin-cell-${i}`, "nsi_score": (Math.random() + 0.0) * 1.0, "gad_z": Math.random() * 1.4 - 0.6, "hb_z": Math.random() * 1.3 - 0.5, "db_z": Math.random() * 2.1 - 0.9, "population": 45000 + Math.floor(Math.random() * 5000) }))
                },
                {
                  "id": "madrid",
                  "name": "Madrid",
                  "name_it": "Madrid",
                  "pn_z": 0.9, "ab_z": 0.1, "hp_z": 1.5, "gb_z": 0.3,
                  "green_ha": 2000, "lat": 40.4168, "lng": -3.7038, "avgSummerC": 32, "population": 3223000,
                  "cecr_score": 0.72,
                   "neighborhood_cells": Array.from({ length: 80 }, (_, i) => ({ "id": `madrid-cell-${i}`, "nsi_score": (Math.random() + 0.5) * 1.5, "gad_z": Math.random() * 2.0, "hb_z": Math.random() * 2.5, "db_z": Math.random() * 2.0 - 0.5, "population": 40000 + Math.floor(Math.random() * 6000) }))
                },
                {
                  "id": "rome",
                  "name": "Rome",
                  "name_it": "Roma",
                  "pn_z": 1.0, "ab_z": -0.2, "hp_z": 1.4, "gb_z": 0.5,
                  "green_ha": 1800, "lat": 41.9028, "lng": 12.4964, "avgSummerC": 31, "population": 2873000,
                  "cecr_score": 0.67,
                  "neighborhood_cells": Array.from({ length: 80 }, (_, i) => ({ "id": `rome-cell-${i}`, "nsi_score": (Math.random() + 0.4) * 1.6, "gad_z": Math.random() * 2.2, "hb_z": Math.random() * 2.4, "db_z": Math.random() * 1.8 - 0.4, "population": 35000 + Math.floor(Math.random() * 5000) }))
                },
                {
                  "id": "lucera",
                  "name": "Lucera",
                  "name_it": "Lucera",
                  "pn_z": 1.4, "ab_z": 0.1, "hp_z": 1.7, "gb_z": -0.6,
                  "green_ha": 150, "lat": 41.5088, "lng": 15.335, "avgSummerC": 33, "population": 32000,
                  "cecr_score": 0.87,
                  "neighborhood_cells": Array.from({ length: 80 }, (_, i) => ({ "id": `lucera-cell-${i}`, "nsi_score": (Math.random() + 0.6) * 1.8, "gad_z": Math.random() * 2.4, "hb_z": Math.random() * 2.8, "db_z": Math.random() * 1.5 - 0.2, "population": 400 + Math.floor(Math.random() * 100) }))
                },
                {
                  "id": "amsterdam",
                  "name": "Amsterdam",
                  "name_it": "Amsterdam",
                  "pn_z": -0.2, "ab_z": 1.2, "hp_z": 0.2, "gb_z": 0.6,
                  "green_ha": 1500, "lat": 52.3676, "lng": 4.9041, "avgSummerC": 22, "population": 821752,
                  "cecr_score": 0.44,
                  "neighborhood_cells": Array.from({ length: 80 }, (_, i) => ({ "id": `amsterdam-cell-${i}`, "nsi_score": (Math.random() - 0.2) * 1.5, "gad_z": Math.random() * 1.5 - 0.5, "hb_z": Math.random() * 1.2 - 0.4, "db_z": Math.random() * 2 - 1, "population": 10000 + Math.floor(Math.random() * 5000) }))
                },
                {
                  "id": "brussels",
                  "name": "Brussels",
                  "name_it": "Bruxelles",
                  "pn_z": 0.1, "ab_z": 0.5, "hp_z": 0.3, "gb_z": 0.2,
                  "green_ha": 1300, "lat": 50.8503, "lng": 4.3517, "avgSummerC": 23, "population": 1200000,
                  "cecr_score": 0.28,
                  "neighborhood_cells": Array.from({ length: 80 }, (_, i) => ({ "id": `brussels-cell-${i}`, "nsi_score": (Math.random() - 0.1) * 1.6, "gad_z": Math.random() * 1.6 - 0.6, "hb_z": Math.random() * 1.3 - 0.3, "db_z": Math.random() * 2.2 - 1, "population": 15000 + Math.floor(Math.random() * 7000) }))
                },
                {
                  "id": "zurich",
                  "name": "Zurich",
                  "name_it": "Zurigo",
                  "pn_z": -1.5, "ab_z": 0.8, "hp_z": 0.1, "gb_z": 0.9,
                  "green_ha": 1000, "lat": 47.3769, "lng": 8.5417, "avgSummerC": 24, "population": 402762,
                  "cecr_score": -0.25,
                  "neighborhood_cells": Array.from({ length: 80 }, (_, i) => ({ "id": `zurich-cell-${i}`, "nsi_score": (Math.random() - 0.5) * 1.2, "gad_z": Math.random() * 1.2 - 0.7, "hb_z": Math.random() * 1.1 - 0.5, "db_z": Math.random() * 1.8 - 0.9, "population": 5000 + Math.floor(Math.random() * 3000) }))
                },
                {
                  "id": "lisbon",
                  "name": "Lisbon",
                  "name_it": "Lisbona",
                  "pn_z": 1.2, "ab_z": 0.3, "hp_z": 1.3, "gb_z": -0.3,
                  "green_ha": 1400, "lat": 38.7223, "lng": -9.1393, "avgSummerC": 28, "population": 504718,
                  "cecr_score": 0.8,
                  "neighborhood_cells": Array.from({ length: 80 }, (_, i) => ({ "id": `lisbon-cell-${i}`, "nsi_score": (Math.random() + 0.3) * 1.8, "gad_z": Math.random() * 2.0, "hb_z": Math.random() * 2.2, "db_z": Math.random() * 1.5, "population": 6000 + Math.floor(Math.random() * 4000) }))
                },
                {
                  "id": "athens",
                  "name": "Athens",
                  "name_it": "Atene",
                  "pn_z": 1.4, "ab_z": -0.5, "hp_z": 1.6, "gb_z": -1.2,
                  "green_ha": 900, "lat": 37.9838, "lng": 23.7275, "avgSummerC": 33, "population": 664046,
                  "cecr_score": 0.61,
                  "neighborhood_cells": Array.from({ length: 80 }, (_, i) => ({ "id": `athens-cell-${i}`, "nsi_score": (Math.random() + 0.5) * 2.0, "gad_z": Math.random() * 2.5, "hb_z": Math.random() * 2.8, "db_z": Math.random() * 1.8, "population": 8000 + Math.floor(Math.random() * 5000) }))
                },
                {
                  "id": "copenhagen",
                  "name": "Copenhagen",
                  "name_it": "Copenaghen",
                  "pn_z": -0.8, "ab_z": 1.1, "hp_z": -0.5, "gb_z": 0.8,
                  "green_ha": 1600, "lat": 55.6761, "lng": 12.5683, "avgSummerC": 22, "population": 602481,
                  "cecr_score": -0.01,
                  "neighborhood_cells": Array.from({ length: 80 }, (_, i) => ({ "id": `copenhagen-cell-${i}`, "nsi_score": (Math.random() - 0.4) * 1.3, "gad_z": Math.random() * 1.3 - 0.8, "hb_z": Math.random() * 1.0 - 0.6, "db_z": Math.random() * 2.0 - 1.0, "population": 7000 + Math.floor(Math.random() * 4000) }))
                },
                {
                  "id": "stockholm",
                  "name": "Stockholm",
                  "name_it": "Stoccolma",
                  "pn_z": -0.7, "ab_z": 0.9, "hp_z": -0.8, "gb_z": 1.5,
                  "green_ha": 2700, "lat": 59.3293, "lng": 18.0686, "avgSummerC": 22, "population": 975904,
                  "cecr_score": 0.0,
                  "neighborhood_cells": Array.from({ length: 80 }, (_, i) => ({ "id": `stockholm-cell-${i}`, "nsi_score": (Math.random() - 0.5) * 1.1, "gad_z": Math.random() * 1.1 - 0.8, "hb_z": Math.random() * 0.8 - 0.7, "db_z": Math.random() * 1.9 - 0.9, "population": 12000 + Math.floor(Math.random() * 6000) }))
                },
                {
                  "id": "oslo",
                  "name": "Oslo",
                  "name_it": "Oslo",
                  "pn_z": -0.9, "ab_z": 0.7, "hp_z": -1.0, "gb_z": 1.8,
                  "green_ha": 2900, "lat": 59.9139, "lng": 10.7522, "avgSummerC": 21, "population": 634293,
                  "cecr_score": -0.17,
                  "neighborhood_cells": Array.from({ length: 80 }, (_, i) => ({ "id": `oslo-cell-${i}`, "nsi_score": (Math.random() - 0.6) * 1.0, "gad_z": Math.random() * 1.0 - 0.9, "hb_z": Math.random() * 0.7 - 0.8, "db_z": Math.random() * 1.7 - 0.8, "population": 8000 + Math.floor(Math.random() * 4000) }))
                },
                {
                  "id": "warsaw",
                  "name": "Warsaw",
                  "name_it": "Varsavia",
                  "pn_z": 0.7, "ab_z": 0.0, "hp_z": 0.4, "gb_z": 0.4,
                  "green_ha": 2100, "lat": 52.2297, "lng": 21.0122, "avgSummerC": 24, "population": 1790000,
                  "cecr_score": 0.4,
                  "neighborhood_cells": Array.from({ length: 80 }, (_, i) => ({ "id": `warsaw-cell-${i}`, "nsi_score": (Math.random() + 0.1) * 1.4, "gad_z": Math.random() * 1.5 - 0.4, "hb_z": Math.random() * 1.4 - 0.2, "db_z": Math.random() * 2.1 - 0.9, "population": 22000 + Math.floor(Math.random() * 10000) }))
                },
                {
                  "id": "prague",
                  "name": "Prague",
                  "name_it": "Praga",
                  "pn_z": 0.2, "ab_z": 0.6, "hp_z": 0.3, "gb_z": 0.7,
                  "green_ha": 1700, "lat": 50.0755, "lng": 14.4378, "avgSummerC": 24, "population": 1300000,
                  "cecr_score": 0.39,
                  "neighborhood_cells": Array.from({ length: 80 }, (_, i) => ({ "id": `prague-cell-${i}`, "nsi_score": (Math.random() - 0.1) * 1.4, "gad_z": Math.random() * 1.4 - 0.5, "hb_z": Math.random() * 1.3 - 0.3, "db_z": Math.random() * 2.0 - 1.0, "population": 16000 + Math.floor(Math.random() * 8000) }))
                },
                {
                  "id": "vienna",
                  "name": "Vienna",
                  "name_it": "Vienna",
                  "pn_z": -0.1, "ab_z": 0.9, "hp_z": 0.4, "gb_z": 1.1,
                  "green_ha": 2300, "lat": 48.2082, "lng": 16.3738, "avgSummerC": 25, "population": 1900000,
                  "cecr_score": 0.32,
                  "neighborhood_cells": Array.from({ length: 80 }, (_, i) => ({ "id": `vienna-cell-${i}`, "nsi_score": (Math.random() - 0.3) * 1.3, "gad_z": Math.random() * 1.3 - 0.6, "hb_z": Math.random() * 1.2 - 0.4, "db_z": Math.random() * 2.0 - 1.0, "population": 23000 + Math.floor(Math.random() * 10000) }))
                },
                {
                  "id": "istanbul",
                  "name": "Istanbul",
                  "name_it": "Istanbul",
                  "pn_z": 1.3, "ab_z": -0.4, "hp_z": 1.2, "gb_z": -0.8,
                  "green_ha": 1900, "lat": 41.0082, "lng": 28.9784, "avgSummerC": 29, "population": 15460000,
                  "cecr_score": 0.56,
                  "neighborhood_cells": Array.from({ length: 80 }, (_, i) => ({ "id": `istanbul-cell-${i}`, "nsi_score": (Math.random() + 0.4) * 1.9, "gad_z": Math.random() * 2.2 - 0.2, "hb_z": Math.random() * 2.5 - 0.1, "db_z": Math.random() * 2.5, "population": 190000 + Math.floor(Math.random() * 50000) }))
                },
                {
                  "id": "moscow",
                  "name": "Moscow",
                  "name_it": "Mosca",
                  "pn_z": 0.6, "ab_z": -0.1, "hp_z": -0.2, "gb_z": 1.3,
                  "green_ha": 4500, "lat": 55.7558, "lng": 37.6173, "avgSummerC": 24, "population": 12500000,
                  "cecr_score": 0.3,
                  "neighborhood_cells": Array.from({ length: 80 }, (_, i) => ({ "id": `moscow-cell-${i}`, "nsi_score": (Math.random() - 0.2) * 1.5, "gad_z": Math.random() * 1.6 - 0.5, "hb_z": Math.random() * 1.0 - 0.5, "db_z": Math.random() * 2.8, "population": 150000 + Math.floor(Math.random() * 40000) }))
                },
                {
                  "id": "barcelona",
                  "name": "Barcelona",
                  "name_it": "Barcellona",
                  "pn_z": 1.1, "ab_z": 0.1, "hp_z": 1.7, "gb_z": -0.5,
                  "green_ha": 1100, "lat": 41.3851, "lng": 2.1734, "avgSummerC": 29, "population": 1620000,
                  "cecr_score": 0.76,
                  "neighborhood_cells": Array.from({ length: 80 }, (_, i) => ({ "id": `barcelona-cell-${i}`, "nsi_score": (Math.random() + 0.4) * 1.9, "gad_z": Math.random() * 2.1, "hb_z": Math.random() * 2.6, "db_z": Math.random() * 2.2, "population": 20000 + Math.floor(Math.random() * 9000) }))
                },
                {
                  "id": "milan",
                  "name": "Milan",
                  "name_it": "Milano",
                  "pn_z": 0.8, "ab_z": -0.1, "hp_z": 1.3, "gb_z": -0.2,
                  "green_ha": 1500, "lat": 45.4642, "lng": 9.1900, "avgSummerC": 29, "population": 1352000,
                  "cecr_score": 0.53,
                  "neighborhood_cells": Array.from({ length: 80 }, (_, i) => ({ "id": `milan-cell-${i}`, "nsi_score": (Math.random() + 0.3) * 1.7, "gad_z": Math.random() * 1.9, "hb_z": Math.random() * 2.4, "db_z": Math.random() * 2.0, "population": 17000 + Math.floor(Math.random() * 8000) }))
                },
                {
                  "id": "bucharest",
                  "name": "Bucharest",
                  "name_it": "Bucarest",
                  "pn_z": 1.5, "ab_z": -0.3, "hp_z": 1.1, "gb_z": 0.1,
                  "green_ha": 1200, "lat": 44.4268, "lng": 26.1025, "avgSummerC": 29, "population": 1883000,
                  "cecr_score": 0.74,
                  "neighborhood_cells": Array.from({ length: 80 }, (_, i) => ({ "id": `bucharest-cell-${i}`, "nsi_score": (Math.random() + 0.4) * 1.8, "gad_z": Math.random() * 2.0, "hb_z": Math.random() * 2.1, "db_z": Math.random() * 1.9, "population": 23000 + Math.floor(Math.random() * 10000) }))
                },
                {
                  "id": "budapest",
                  "name": "Budapest",
                  "name_it": "Budapest",
                  "pn_z": 0.9, "ab_z": 0.2, "hp_z": 0.8, "gb_z": 0.6,
                  "green_ha": 1600, "lat": 47.4979, "lng": 19.0402, "avgSummerC": 27, "population": 1752000,
                  "cecr_score": 0.64,
                  "neighborhood_cells": Array.from({ length: 80 }, (_, i) => ({ "id": `budapest-cell-${i}`, "nsi_score": (Math.random() + 0.2) * 1.6, "gad_z": Math.random() * 1.7 - 0.3, "hb_z": Math.random() * 1.8 - 0.1, "db_z": Math.random() * 2.1, "population": 21000 + Math.floor(Math.random() * 9000) }))
                },
                {
                  "id": "hamburg",
                  "name": "Hamburg",
                  "name_it": "Amburgo",
                  "pn_z": 0.0, "ab_z": 0.6, "hp_z": 0.1, "gb_z": 1.4,
                  "green_ha": 2500, "lat": 53.5511, "lng": 9.9937, "avgSummerC": 22, "population": 1841000,
                  "cecr_score": 0.34,
                  "neighborhood_cells": Array.from({ length: 80 }, (_, i) => ({ "id": `hamburg-cell-${i}`, "nsi_score": (Math.random() - 0.3) * 1.4, "gad_z": Math.random() * 1.4 - 0.6, "hb_z": Math.random() * 1.1 - 0.5, "db_z": Math.random() * 2.0, "population": 23000 + Math.floor(Math.random() * 8000) }))
                },
                {
                  "id": "napoli",
                  "name": "Naples",
                  "name_it": "Napoli",
                  "pn_z": 1.6, "ab_z": -0.4, "hp_z": 1.8, "gb_z": -1.5,
                  "green_ha": 800, "lat": 40.8518, "lng": 14.2681, "avgSummerC": 30, "population": 962000,
                  "cecr_score": 0.73,
                  "neighborhood_cells": Array.from({ length: 80 }, (_, i) => ({ "id": `napoli-cell-${i}`, "nsi_score": (Math.random() + 0.6) * 2.2, "gad_z": Math.random() * 2.8, "hb_z": Math.random() * 3.0, "db_z": Math.random() * 2.0, "population": 12000 + Math.floor(Math.random() * 7000) }))
                }
              ]
            };
            
            // Prepare data for the application from the consolidated source
            const cityData = consolidatedAppData.cities.map(city => ({ 
                ...city, 
                cecr: city.cecr_score 
            }));

            const neighborhoodData = Object.fromEntries(consolidatedAppData.cities.map(city => {
                const processedCells = city.neighborhood_cells.map(cell => ({
                    ...cell,
                    nsi: cell.nsi_score, // Rename for consistency with existing code
                    // Add missing properties that were generated dynamically before for the layer toggles to work
                    gad_p: Math.floor(Math.random() * 100), 
                    hb_p: Math.floor(Math.random() * 100)
                }));
                return [city.id, processedCells];
            }));
            
            const cityViewBtn = document.getElementById('city-view-btn'), neighborhoodViewBtn = document.getElementById('neighborhood-view-btn'), cityInfoPanel = document.getElementById('city-info-panel'), neighborhoodInfoPanel = document.getElementById('neighborhood-info-panel'), cityRankingList = document.getElementById('city-ranking-list'), hexGrid = document.querySelector('#neighborhood-map-view .hex-grid'), dataLegend = document.getElementById('data-legend'), hexTooltip = document.getElementById('hex-tooltip'), langSwitcher = document.getElementById('lang-switcher');
            let currentView = 'city', selectedCity = null;

            function setLanguage(lang) {
                currentLanguage = lang;
                const t = translations[lang];
                const isMobile = window.innerWidth < 640;
                
                document.getElementById('guide-text').textContent = isMobile ? '' : t.guide;
                document.getElementById('stakeholder-text').textContent = isMobile ? '' : t.stakeholders;
                document.getElementById('guide-title').textContent = t.guideTitle;
                document.getElementById('stakeholder-title').textContent = t.stakeholderMapTitle;
                document.getElementById('select-city-title').textContent = t.selectCityTitle;
                
                // New menu buttons
                document.getElementById('guide-menu-text').textContent = t.guideMenu;
                document.getElementById('stakeholder-menu-text').textContent = t.stakeholdersMenu;
                document.getElementById('cecr-menu-text').textContent = t.cecrViewMenu;
                document.getElementById('nsi-menu-text').textContent = t.nsiViewMenu;

                cityViewBtn.textContent = isMobile ? t.cityReadinessShort : t.cityReadiness;
                neighborhoodViewBtn.textContent = isMobile ? t.neighborhoodPriorityShort : t.neighborhoodPriority;
                document.getElementById('city-rankings-title').textContent = t.cityRankingsTitle;
                document.getElementById('neighborhood-analysis-title').textContent = t.neighborhoodAnalysisTitle;

                document.getElementById('nasa-data-source-title-cecr').textContent = t.nasaDataSourceTitleCECR;
                document.getElementById('city-data-source-content').innerHTML = t.nasaDataSourceContentCECR;
                document.getElementById('nasa-data-source-title-nsi').textContent = t.nasaDataSourceTitleNSI;
                document.getElementById('neighborhood-data-source-content').innerHTML = t.nasaDataSourceContentNSI;
                document.getElementById('cecr-scope-title').textContent = t.toolScopeCECRTitle;
                document.getElementById('cecr-scope-content').innerHTML = t.toolScopeCECRContent;
                document.getElementById('nsi-scope-title').textContent = t.toolScopeNSITitle;
                document.getElementById('nsi-scope-content').innerHTML = t.toolScopeNSIContent;

                // Translate API Key Section
                document.querySelector('#api-key-content h3').textContent = t.enableAIFeatures;
                document.querySelector('#api-key-content p').textContent = t.enterApiKey;
                document.getElementById('save-api-key-btn').textContent = t.save;
                document.getElementById('api-key-status').textContent = t.apiKeySaved;


                document.getElementById('lang-flag').src = lang === 'en' ? 'https://flagcdn.com/w20/gb.png' : 'https://flagcdn.com/w20/it.png';
                document.getElementById('lang-text').textContent = lang.toUpperCase();
                document.getElementById('lang-flag-guide').src = lang === 'en' ? 'https://flagcdn.com/w20/gb.png' : 'https://flagcdn.com/w20/it.png';
                document.getElementById('lang-text-guide').textContent = lang.toUpperCase();

                const guideModalContent = document.querySelector('#guide-modal .overflow-y-auto');
                guideModalContent.innerHTML = t.guideContent;

                const disclaimerContent = document.getElementById('disclaimer-content');
                if (disclaimerContent) {
                    disclaimerContent.innerHTML = `<strong>${t.disclaimerTitle}</strong> ${t.disclaimerText}`;
                }

                renderCities();
                updateLegend(currentView);
                if (cityInfoPanel.dataset.cityId) { renderCityInfo(cityData.find(c => c.id === cityInfoPanel.dataset.cityId)); }
                if (neighborhoodInfoPanel.dataset.cellId) { renderNeighborhoodInfo(neighborhoodData[selectedCity.id].find(c => c.id === neighborhoodInfoPanel.dataset.cellId)); }
                
                document.querySelectorAll('#map-layer-switcher button').forEach(btn => {
                    const key = btn.dataset.layerKey;
                    if(key && mapLayers[key]) {
                        btn.textContent = mapLayers[key]['name_' + lang] || mapLayers[key].name;
                    }
                });
                
                const selectedCityNameSpan = document.getElementById('selected-city-name-menu');
                if (selectedCity) {
                    selectedCityNameSpan.textContent = selectedCity['name_' + lang] || selectedCity.name;
                } else {
                    selectedCityNameSpan.textContent = '';
                }
            }

            langSwitcher.addEventListener('click', () => setLanguage(currentLanguage === 'en' ? 'it' : 'en'));
            document.getElementById('city-data-source-btn').addEventListener('click', (e) => {
                document.getElementById('city-data-source-content').classList.toggle('hidden');
                e.currentTarget.querySelector('svg').classList.toggle('rotate-180');
            });
             document.getElementById('neighborhood-data-source-btn').addEventListener('click', (e) => {
                document.getElementById('neighborhood-data-source-content').classList.toggle('hidden');
                e.currentTarget.querySelector('svg').classList.toggle('rotate-180');
            });
            document.getElementById('cecr-scope-btn').addEventListener('click', (e) => {
                document.getElementById('cecr-scope-content').classList.toggle('hidden');
                e.currentTarget.querySelector('svg').classList.toggle('rotate-180');
            });
            document.getElementById('nsi-scope-btn').addEventListener('click', (e) => {
                document.getElementById('nsi-scope-content').classList.toggle('hidden');
                e.currentTarget.querySelector('svg').classList.toggle('rotate-180');
            });
            
            const cityListToggleBtn = document.getElementById('city-list-toggle-btn');
            const cityListContainer = document.getElementById('city-ranking-list-container');
            const cityListArrow = document.getElementById('city-list-arrow');
            cityListToggleBtn.addEventListener('click', () => {
                cityListContainer.classList.toggle('hidden');
                cityListArrow.classList.toggle('rotate-180');
            });

            function switchMapLayer(layerKey) {
                if (currentMapLayer) { map.removeLayer(currentMapLayer); }
                const layer = mapLayers[layerKey];
                currentMapLayer = L.tileLayer(layer.url, layer.options).addTo(map);
                
                document.querySelectorAll('#map-layer-switcher button').forEach(btn => {
                    if (btn.dataset.layerKey) {
                        btn.classList.toggle('active-toggle', btn.dataset.layerKey === layerKey);
                        btn.classList.toggle('inactive-toggle', btn.dataset.layerKey !== layerKey);
                    }
                });
            }

            function initMap() {
                map = L.map('map-container', { zoomControl: false, attributionControl: true }).setView([50, 15], 4.5);
                switchMapLayer('dark');
                L.control.zoom({ position: 'topright' }).addTo(map);

                const layerSwitcherContainer = document.getElementById('map-layer-switcher');
                Object.keys(mapLayers).forEach(key => {
                    const layer = mapLayers[key];
                    const button = document.createElement('button');
                    button.className = 'px-3 py-1.5 text-xs font-semibold rounded-md transition-colors duration-300 glass-panel';
                    button.textContent = layer.name;
                    button.dataset.layerKey = key;
                    button.addEventListener('click', () => switchMapLayer(key));
                    layerSwitcherContainer.appendChild(button);
                });
                
                document.querySelector('#map-layer-switcher button[data-layer-key="dark"]').classList.add('active-toggle');
            }

            const createRadarChart = (city) => {
                const zScores = [city.pn_z, city.ab_z, city.hp_z, city.gb_z]; const size = 120; const center = size / 2; let points = '';
                zScores.forEach((score, i) => {
                    const value = Math.max(0, (score + 1.5) / 3); const angle = (Math.PI / 2) - (i * Math.PI / 2); const x = center + center * value * 0.8 * Math.cos(angle); const y = center - center * value * 0.8 * Math.sin(angle); points += `${x},${y} `;
                });
                return `<svg viewBox="0 0 ${size} ${size}" class="w-full h-auto">
                    <circle cx="${center}" cy="${center}" r="${center * 0.8}" fill="none" stroke="#4a5568" stroke-width="0.5"/><circle cx="${center}" cy="${center}" r="${center * 0.5}" fill="none" stroke="#4a5568" stroke-width="0.5"/><line x1="${center}" y1="${center*0.2}" x2="${center}" y2="${center*1.8}" stroke="#4a5568" stroke-width="0.5"/><line x1="${center*0.2}" y1="${center}" x2="${center*1.8}" y2="${center}" stroke="#4a5568" stroke-width="0.5"/><polygon points="${points}" fill="rgba(129, 140, 248, 0.4)" stroke="#818cf8" stroke-width="1.5"/>
                </svg>`;
            };

            const renderCities = () => {
                const t = translations[currentLanguage];
                cityRankingList.innerHTML = '';
                cityMarkers.forEach(marker => map.removeLayer(marker));
                cityMarkers = [];
                const sortedCities = [...cityData].sort((a, b) => b.cecr - a.cecr);
                
                sortedCities.forEach(city => {
                    const colorIntensity = Math.min(1, Math.max(0, (city.cecr - (-0.5)) / 1.8));
                    const color = `rgb(255, ${Math.floor(200 * (1 - colorIntensity))}, ${Math.floor(100 * (1 - colorIntensity))})`;
                    
                    const radius = 5 + (city.green_ha / 1000);
                    const iconSize = radius * 2;

                    const customIcon = L.divIcon({
                        html: `<div class="pulsing-marker" style="width: ${iconSize}px; height: ${iconSize}px; background-color: ${color};"></div>`,
                        className: '', // Prevent default leaflet styles
                        iconSize: [iconSize, iconSize],
                        iconAnchor: [radius, radius]
                    });

                    const marker = L.marker([city.lat, city.lng], { icon: customIcon }).addTo(map);

                    marker.on('click', () => renderCityInfo(city));

                    // Add hover effects for desktop for better interactivity feedback
                    marker.on('mouseover', function (e) {
                        const iconDiv = e.target.getElement();
                        if (iconDiv) {
                            iconDiv.style.zIndex = 1000; // Bring to front
                            const innerDiv = iconDiv.querySelector('.pulsing-marker');
                            if (innerDiv) {
                                innerDiv.style.animationPlayState = 'paused';
                                innerDiv.style.transform = 'scale(1.25)';
                            }
                        }
                    });

                    marker.on('mouseout', function (e) {
                        const iconDiv = e.target.getElement();
                        if (iconDiv) {
                            const innerDiv = iconDiv.querySelector('.pulsing-marker');
                            if (innerDiv) {
                                innerDiv.style.animationPlayState = 'running';
                                innerDiv.style.transform = 'scale(1)';
                            }
                        }
                    });
                    
                    cityMarkers.push(marker);
                    
                    const cityName = city['name_' + currentLanguage] || city.name;
                    const rankEl = document.createElement('div');
                    rankEl.className = 'p-2 rounded-md hover:bg-gray-800 cursor-pointer transition-colors';
                    rankEl.dataset.cityId = city.id;
                    rankEl.innerHTML = `<div class="flex items-center justify-between"><div class="flex items-center truncate"><span class="w-3 h-3 rounded-full mr-3 flex-shrink-0" style="background-color: ${color};"></span><div><p class="font-semibold truncate">${cityName}</p><p class="text-xs text-gray-500">Pop: ${city.population.toLocaleString()}</p></div></div><span class="text-sm font-bold ml-2 ${city.cecr > 0.5 ? 'text-red-400' : 'text-yellow-400'}">${city.cecr.toFixed(2)}</span></div>`;
                    cityRankingList.appendChild(rankEl);
                });
            };
            
            const renderCityInfo = (city) => {
                selectedCity = city; // CRITICAL FIX: Update the global selected city
                const t = translations[currentLanguage];
                cityInfoPanel.dataset.cityId = city.id;
                cityInfoPanel.innerHTML = ''; // Clear previous content
                document.querySelectorAll('#city-ranking-list > div').forEach(el => el.classList.toggle('active-rank-item', el.dataset.cityId === city.id));
                const impactFood = (city.green_ha * 0.1 * 9.5);
                const peopleSustained = ((impactFood * 2000) / 365) / 2;
                const scoreColor = city.cecr > 0.5 ? 'bg-red-500/20 text-red-300' : 'bg-yellow-500/20 text-yellow-300';

                const calculationDetails = `
                    <div class="flex justify-between items-center text-sm py-2 border-b border-white/10">
                        <div class="flex items-center gap-2"><svg class="w-5 h-5 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg><span>${t.povertyNeed}</span></div>
                        <span class="font-mono text-gray-400">${city.pn_z.toFixed(2)}</span>
                    </div>
                    <div class="flex justify-between items-center text-sm py-2 border-b border-white/10">
                        <div class="flex items-center gap-2"><svg class="w-5 h-5 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg><span>${t.accessibilityBonus}</span></div>
                        <span class="font-mono text-gray-400">${city.ab_z.toFixed(2)}</span>
                    </div>
                    <div class="flex justify-between items-center text-sm py-2 border-b border-white/10">
                        <div class="flex items-center gap-2"><svg class="w-5 h-5 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg><span>${t.heatHealthPriority}</span></div>
                        <span class="font-mono text-gray-400">${city.hp_z.toFixed(2)}</span>
                    </div>
                    <div class="flex justify-between items-center text-sm py-2">
                        <div class="flex items-center gap-2"><svg class="w-5 h-5 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 15.75l-2.489-2.489m0 0a3.375 3.375 0 10-4.773-4.773 3.375 3.375 0 004.774 4.774zM21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><span>${t.greenBase}</span></div>
                        <span class="font-mono text-gray-400">${city.gb_z.toFixed(2)}</span>
                    </div>`;

                const impactDetails = `
                    <div class="bg-gray-800/50 p-3 rounded-lg text-center">
                        <p class="text-sm text-yellow-300">${t.microOrchardEstDim.replace('🌳 ','')}</p>
                        <p class="text-2xl font-bold text-white">${(city.green_ha * 0.1).toFixed(1)}</p>
                        <p class="text-xs text-gray-400">ha</p>
                    </div>
                    <div class="bg-gray-800/50 p-3 rounded-lg text-center">
                        <p class="text-sm text-green-300">${t.estFoodProduction}</p>
                        <p class="text-xl font-bold text-white">${impactFood.toFixed(0)}</p>
                        <p class="text-xs text-gray-400">${t.tonnesYear}</p>
                    </div>
                    <div class="bg-gray-800/50 p-3 rounded-lg text-center">
                        <p class="text-sm text-purple-300">${t.foodRations}</p>
                        <p class="text-xl font-bold text-white">${Math.round(impactFood * 2000).toLocaleString()}</p>
                        <p class="text-xs text-gray-400">${t.portionsYear}</p>
                    </div>
                    <div class="bg-gray-800/50 p-3 rounded-lg text-center">
                        <p class="text-sm text-orange-400">${t.estPeopleSustained}</p>
                        <p class="text-xl font-bold text-white">${Math.floor(peopleSustained)}</p>
                        <p class="text-xs text-gray-400">${t.sustainedDaily}</p>
                    </div>`;
                
                const cityName = city['name_' + currentLanguage] || city.name;
                document.getElementById('selected-city-name-menu').textContent = `: ${cityName}`;

                cityInfoPanel.innerHTML = `
                    <button id="close-city-panel" class="absolute top-4 right-4 sm:top-6 sm:right-6 text-gray-400 hover:text-white text-3xl z-20">&times;</button>
                    <div class="h-full overflow-y-auto rounded-2xl sm:rounded-none">
                        <div class="p-6 pt-16 sm:pt-6 space-y-6">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h2 class="text-2xl font-bold">${cityName}</h2>
                                    <p class="text-sm text-gray-400">Population: ${city.population.toLocaleString()}</p>
                                </div>
                                <div class="text-right">
                                        <span class="text-3xl font-bold ${scoreColor.split(' ')[1]}">${city.cecr.toFixed(2)}</span>
                                </div>
                            </div>

                            <div class="bg-gray-900/50 p-4 rounded-lg">
                                <h3 class="font-semibold mb-3 text-gray-300">${t.cecrCalcTitle}</h3>
                                <div class="grid grid-cols-2 gap-4 items-center">
                                    <div>${createRadarChart(city)}</div>
                                    <div class="space-y-1">${calculationDetails}</div>
                                </div>
                                <div class="mt-4 pt-3 border-t border-white/10">
                                    <p class="text-xs text-center text-gray-400 font-mono">CECR = 0.4*z(PN) + 0.3*z(AB) + 0.2*z(HP) + 0.1*z(GB)</p>
                                </div>
                            </div>

                            <div class="bg-gray-900/50 p-4 rounded-lg">
                                <h3 class="font-semibold mb-3 text-gray-300">${t.projectedImpact}</h3>
                                <div class="grid grid-cols-2 gap-2">${impactDetails}</div>
                            </div>
                            
                            <div class="bg-gray-900/50 p-4 rounded-lg">
                                <h3 class="font-semibold mb-3 text-gray-300">AI Analysis</h3>
                                <div id="gemini-city-output" class="mb-4 hidden"></div>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                    <button id="interpret-city-data-btn" data-city-id="${city.id}" class="w-full bg-blue-600 text-white font-bold py-2.5 rounded-lg hover:bg-blue-500 transition-colors flex items-center justify-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed" title="Enter API Key to enable"><span>${t.dataInterpretation}</span></button>
                                    <button id="analyze-green-areas-btn" data-city-id="${city.id}" class="w-full bg-green-600 text-white font-bold py-2.5 rounded-lg hover:bg-green-500 transition-colors flex items-center justify-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed" title="Enter API Key to enable"><span>${t.analyzeGreenSpaces}</span></button>
                                </div>
                            </div>
                            
                            <button id="drill-down-btn" data-city-id="${city.id}" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-500 transition-colors">${t.drillDown}</button>
                        </div>
                    </div>`;

                cityInfoPanel.classList.remove('translate-x-full');
                document.getElementById('close-city-panel').addEventListener('click', () => cityInfoPanel.classList.add('translate-x-full'));
                document.getElementById('drill-down-btn').addEventListener('click', (e) => switchView('neighborhood', cityData.find(c => c.id === e.currentTarget.dataset.cityId)));
                document.getElementById('analyze-green-areas-btn').addEventListener('click', handleAnalyzeGreenSpaces);
                document.getElementById('interpret-city-data-btn').addEventListener('click', handleInterpretCityData);
            };

            const renderNeighborhoods = (cityId, layer = 'nsi') => {
                const data = neighborhoodData[cityId] || []; 
                hexGrid.innerHTML = ''; 
                if (data.length === 0) return;

                const containerWidth = hexGrid.offsetWidth;
                const containerHeight = hexGrid.offsetHeight;
                const centerX = containerWidth / 2;
                const centerY = containerHeight / 2;
                
                const hexesPerCircle = [1, 6, 12, 18, 24, 30]; 
                const radiusStep = 75; 
                let hexIndex = 0;

                for (let circle = 0; circle < hexesPerCircle.length && hexIndex < data.length; circle++) {
                    const numHexesInThisCircle = hexesPerCircle[circle];
                    const radius = circle * radiusStep;
                    
                    for (let i = 0; i < numHexesInThisCircle && hexIndex < data.length; i++) {
                        const cell = data[hexIndex];
                        const angle = (i / numHexesInThisCircle) * 2 * Math.PI;

                        let x, y;
                        if (circle === 0) { // Center hexagon
                            x = centerX - 40;
                            y = centerY - 46;
                        } else {
                            x = centerX + radius * Math.cos(angle) - 40;
                            y = centerY + radius * Math.sin(angle) - 46;
                        }

                        let colorIntensity;
                        switch(layer) { case 'heat': colorIntensity = cell.hb_p / 100; break; case 'access': colorIntensity = cell.gad_p / 100; break; case 'density': colorIntensity = (cell.db_z + 1.5) / 3; break; default: colorIntensity = Math.min(1, Math.max(0, (cell.nsi - (-0.5)) / 2.5)); }
                        const color = `rgba(255, ${Math.floor(200 * (1 - colorIntensity))}, ${Math.floor(100 * (1 - colorIntensity))}, 0.8)`;
                        const hexEl = document.createElement('div'); hexEl.className = 'hex'; 
                        hexEl.style.backgroundColor = color; 
                        hexEl.dataset.cellId = cell.id;
                        hexEl.style.position = 'absolute';
                        hexEl.style.left = `${x}px`;
                        hexEl.style.top = `${y}px`;
                        hexEl.innerHTML = `<span class="hex-value">${cell.nsi.toFixed(2)}</span>`;
                        
                        hexEl.addEventListener('mouseenter', (e) => {
                            const cellData = neighborhoodData[selectedCity.id].find(c => c.id === e.target.dataset.cellId);
                            hexTooltip.style.display = 'block';
                            hexTooltip.innerHTML = `<strong>NSI: ${cellData.nsi.toFixed(2)}</strong><br>Heat: ${cellData.hb_p}%<br>Access: ${cellData.gad_p}%<br>Density: ${cellData.db_z > 0 ? '+' : ''}${cellData.db_z.toFixed(2)}σ`;
                        });
                        hexEl.addEventListener('mouseleave', () => { hexTooltip.style.display = 'none'; });
                        hexEl.addEventListener('mousemove', (e) => { hexTooltip.style.left = `${e.clientX + 15}px`; hexTooltip.style.top = `${e.clientY + 15}px`; });

                        hexGrid.appendChild(hexEl);
                        hexIndex++;
                    }
                }
            };
            
            const renderNeighborhoodInfo = (cell) => {
                const t = translations[currentLanguage];
                neighborhoodInfoPanel.dataset.cellId = cell.id;
                neighborhoodInfoPanel.innerHTML = ''; // Clear previous content
                document.querySelectorAll('.hex.selected').forEach(el => el.classList.remove('selected'));
                const hexEl = document.querySelector(`.hex[data-cell-id="${cell.id}"]`);
                if (hexEl) hexEl.classList.add('selected');
                
                const scoreColor = cell.nsi > 0.5 ? 'bg-red-500/20 text-red-300' : 'bg-yellow-500/20 text-yellow-300';

                const nsiCalcDetails = `<div class="space-y-2 text-sm">
                    <div class="flex justify-between items-center py-2 border-b border-white/10">
                        <div class="flex items-center gap-2"><svg class="w-5 h-5 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg><span>${t.gad}</span></div>
                        <span class="font-mono text-gray-400">${cell.gad_z.toFixed(2)}</span>
                    </div>
                    <div class="flex justify-between items-center py-2 border-b border-white/10">
                        <div class="flex items-center gap-2"><svg class="w-5 h-5 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg><span>${t.hb}</span></div>
                        <span class="font-mono text-gray-400">${cell.hb_z.toFixed(2)}</span>
                    </div>
                    <div class="flex justify-between items-center py-2">
                            <div class="flex items-center gap-2"><svg class="w-5 h-5 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"></path></svg><span>${t.db}</span></div>
                        <span class="font-mono text-gray-400">${cell.db_z.toFixed(2)}</span>
                    </div>
                </div>`;
                
                const contextualDetails = `<div class="space-y-2 text-sm">
                    <div class="flex justify-between"><span>${t.city}</span><span class="font-bold">${selectedCity['name_' + currentLanguage] || selectedCity.name}</span></div>
                    <div class="flex justify-between"><span>${t.avgSummerTemp}</span><span class="font-bold">${selectedCity.avgSummerC}°C</span></div>
                    <div class="flex justify-between"><span>${t.estCellPopulation}</span><span class="font-bold">${cell.population.toLocaleString()}</span></div>
                </div>`;
                
                const convertibleHa = 2.0 / (1 + cell.nsi);
                const potentialFood = convertibleHa * 9.5;
                const potentialPortions = potentialFood * 2000;
                const coolingEffect = convertibleHa * 0.5; // Simple estimation: 0.5°C cooling per hectare
                const peopleSustained = (potentialPortions / 365) / 2;

                const potentialImpactHTML = `
                    <div class="bg-gray-800/50 p-3 rounded-lg text-center">
                        <p class="text-sm text-yellow-300">${t.estConvertibleArea.replace('🌳 ','')}</p>
                        <p class="text-2xl font-bold text-white">${convertibleHa.toFixed(1)}</p>
                        <p class="text-xs text-gray-400">ha</p>
                    </div>
                    <div class="bg-gray-800/50 p-3 rounded-lg text-center">
                        <p class="text-sm text-green-300">${t.estFoodProduction}</p>
                        <p class="text-xl font-bold text-white">${potentialFood.toFixed(1)}</p>
                        <p class="text-xs text-gray-400">${t.tonnesYear}</p>
                    </div>
                    <div class="bg-gray-800/50 p-3 rounded-lg text-center">
                        <p class="text-sm text-purple-300">${t.foodRations}</p>
                        <p class="text-xl font-bold text-white">${Math.round(potentialPortions).toLocaleString()}</p>
                        <p class="text-xs text-gray-400">${t.portionsYear}</p>
                    </div>
                    <div class="bg-gray-800/50 p-3 rounded-lg text-center">
                        <p class="text-sm text-blue-300">${t.estSummerCooling}</p>
                        <p class="text-xl font-bold text-white">~${coolingEffect.toFixed(1)}°C</p>
                        <p class="text-xs text-gray-400">${t.peakTempReduction}</p>
                    </div>
                     <div class="bg-gray-800/50 p-3 rounded-lg text-center">
                        <p class="text-sm text-pink-300">${t.potentialBeneficiaries}</p>
                        <p class="text-xl font-bold text-white">${cell.population.toLocaleString()}</p>
                        <p class="text-xs text-gray-400">${t.inThisNeighborhood}</p>
                    </div>
                    <div class="bg-gray-800/50 p-3 rounded-lg text-center">
                        <p class="text-sm text-orange-400">${t.estPeopleSustained}</p>
                        <p class="text-xl font-bold text-white">${Math.floor(peopleSustained)}</p>
                        <p class="text-xs text-gray-400">${t.sustainedDaily}</p>
                    </div>
                `;

                const layerButtonsHTML = `<div class="p-1 bg-gray-900 rounded-lg flex items-center" id="neighborhood-layer-toggles">
                                    <button data-layer="nsi" class="flex-1 text-center py-1.5 rounded-md font-semibold text-sm layer-toggle">${t.nsiHeatmap}</button>
                                    <button data-layer="heat" class="flex-1 text-center py-1.5 rounded-md text-sm layer-toggle">${t.heatBurden}</button>
                                    <button data-layer="access" class="flex-1 text-center py-1.5 rounded-md text-sm layer-toggle">${t.greenAccessDeficit}</button>
                                     <button data-layer="density" class="flex-1 text-center py-1.5 rounded-md text-sm layer-toggle">${t.populationDensity}</button>
                                </div>`;

                neighborhoodInfoPanel.innerHTML = `
                 <button id="close-neighborhood-panel" class="absolute top-4 right-4 sm:top-6 sm:right-6 text-gray-400 hover:text-white text-3xl z-20">&times;</button>
                 <div class="h-full overflow-y-auto rounded-2xl sm:rounded-none">
                     <div class="p-6 pt-16 sm:pt-6 space-y-6">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h2 class="text-2xl font-bold">Cell ${cell.id.split('-').pop().toUpperCase()}</h2>
                                    <p class="text-sm text-gray-400">in ${selectedCity['name_' + currentLanguage] || selectedCity.name}</p>
                                </div>
                                <div class="text-right">
                                    <span class="text-3xl font-bold ${scoreColor.split(' ')[1]}">${cell.nsi.toFixed(2)}</span>
                                    <p class="text-sm text-gray-400 -mt-1">${t.nsiScore}</p>
                                </div>
                            </div>

                            <button id="back-to-city-view-btn" class="w-full flex items-center justify-center gap-2 text-sm py-2 bg-gray-700/50 hover:bg-gray-700 rounded-lg transition-colors"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg> Back to City View</button>

                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div class="bg-gray-900/50 p-4 rounded-lg">
                                ${nsiCalcDetails}
                                <div class="mt-3 pt-3 border-t border-white/10">
                                    <p class="text-xs text-center text-gray-400 font-mono">NSI = 0.5*z(GAD) + 0.3*z(HB) + 0.2*z(DB)</p>
                                </div>
                            </div>
                            <div class="bg-gray-900/50 p-4 rounded-lg">
                                <h3 class="font-semibold mb-2 text-gray-300">${t.contextualData}</h3>
                                ${contextualDetails}
                            </div>
                        </div>

                        <div class="bg-gray-900/50 p-4 rounded-lg">
                            <h3 class="font-semibold mb-3 text-gray-300">${t.potentialImpact}</h3>
                            <div class="grid grid-cols-2 sm:grid-cols-3 gap-2">${potentialImpactHTML}</div>
                        </div>

                        <div class="bg-gray-900/50 p-4 rounded-lg">
                            <h3 class="font-semibold mb-3 text-gray-300">${t.dataOverlays}</h3>
                            ${layerButtonsHTML}
                        </div>
                        
                        <div class="bg-gray-900/50 p-4 rounded-lg">
                            <h3 class="font-semibold mb-3 text-gray-300">AI Analysis</h3>
                             <div id="gemini-neighborhood-output" class="mb-4 hidden"></div>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                    <button id="interpret-neighborhood-data-btn" data-cell-id="${cell.id}" class="w-full bg-blue-600 text-white font-bold py-2.5 rounded-lg hover:bg-blue-500 transition-colors flex items-center justify-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed" title="Enter API Key to enable"><span>${t.dataInterpretation}</span></button>
                                    <button id="analyze-neighborhood-btn" data-cell-id="${cell.id}" class="w-full bg-teal-600 text-white font-bold py-2.5 rounded-lg hover:bg-teal-500 transition-colors flex items-center justify-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed" title="Enter API Key to enable"><span>${t.analyzePotential}</span></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;

                neighborhoodInfoPanel.classList.remove('translate-x-full');
                
                document.getElementById('back-to-city-view-btn').addEventListener('click', () => switchView('city'));
                document.getElementById('close-neighborhood-panel').addEventListener('click', () => {
                    neighborhoodInfoPanel.classList.add('translate-x-full');
                    if(hexEl) hexEl.classList.remove('selected');
                });
                
                // Add layer toggle functionality
                document.querySelectorAll('#neighborhood-info-panel .layer-toggle').forEach(toggle => {
                    toggle.addEventListener('click', () => {
                        currentNeighborhoodLayer = toggle.dataset.layer;
                        renderNeighborhoods(selectedCity.id, currentNeighborhoodLayer);
                        updateLegend('neighborhood', currentNeighborhoodLayer);
                        
                        document.querySelectorAll('#neighborhood-info-panel .layer-toggle').forEach(t => t.classList.remove('bg-indigo-600', 'text-white'));
                        toggle.classList.add('bg-indigo-600', 'text-white');
                    });
                });

                const activeButton = document.querySelector(`#neighborhood-info-panel .layer-toggle[data-layer="${currentNeighborhoodLayer}"]`);
                if (activeButton) {
                    activeButton.classList.add('bg-indigo-600', 'text-white');
                }

                document.getElementById('analyze-neighborhood-btn').addEventListener('click', handleAnalyzeNeighborhood);
                document.getElementById('interpret-neighborhood-data-btn').addEventListener('click', handleInterpretNeighborhoodData);
            };
            
            const updateLegend = (view, layer = 'nsi') => {
                const t = translations[currentLanguage];
                let content = '';
                if(view === 'city') { content = `<div class="flex justify-between items-center text-sm text-gray-300"><span>${t.lowReadiness}</span><div class="flex-grow h-2 rounded-full mx-2" style="background: linear-gradient(to right, rgb(255, 200, 100), rgb(255, 0, 0));"></div><span>${t.highReadiness}</span></div><p class="text-center text-sm text-gray-400 mt-1">${t.cecrScore}</p>`; } else { const titles = {nsi: t.nsiScore, heat: t.heatBurden, access: t.greenAccessDeficit, density: t.populationDensity}; content = `<div class="flex justify-between items-center text-sm text-gray-300"><span>${t.lowPriority}</span><div class="flex-grow h-2 rounded-full mx-2" style="background: linear-gradient(to right, rgb(255, 200, 100), rgb(255, 0, 0));"></div><span>${t.highPriority}</span></div><p class="text-center text-sm text-gray-400 mt-1">${titles[layer]}</p>`; }
                dataLegend.innerHTML = content;
            };

            async function callGeminiAPI(systemPrompt, userQuery, button, outputDiv) {
                if (currentLanguage === 'it') {
                    systemPrompt += "\nIMPORTANT: Your entire response MUST be in Italian.";
                }
                const apiKey = localStorage.getItem('geminiApiKey') || defaultApiKey;
                if (!apiKey) {
                    const t = translations[currentLanguage];
                    outputDiv.innerHTML = `<div class="bg-red-900/80 p-4 rounded-lg text-sm text-white">Error: API Key is missing. Please add one in the settings panel.</div>`;
                    return;
                }

                button.disabled = true; button.innerHTML = `<span class="loader"></span><span>Generating...</span>`; outputDiv.classList.remove('hidden'); outputDiv.innerHTML = `<div class="bg-gray-900/50 p-4 rounded-lg text-sm text-gray-300">Please wait while the AI analyzes the data...</div>`;
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const payload = { systemInstruction: { parts: [{ text: systemPrompt }] }, contents: [{ parts: [{ text: userQuery }] }], };
                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); if (!response.ok) throw new Error(`API call failed with status: ${response.status}. Please check your API key.`);
                    const result = await response.json(); const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (text) { 
                        let formattedText = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*/g, '•').replace(/\n/g, '<br>');
                        outputDiv.innerHTML = `<div class="gemini-output bg-gray-900/50 p-4 rounded-lg text-base">${formattedText}</div>`; 
                    } else { throw new Error("No text found in API response."); }
                } catch (error) { console.error("Gemini API call error:", error); outputDiv.innerHTML = `<div class="bg-red-900/80 p-4 rounded-lg text-sm text-white">Error: Could not generate analysis. ${error.message}</div>`; } finally {
                    button.disabled = false;
                    const originalTexts = { 'analyze-green-areas-btn': translations[currentLanguage].analyzeGreenSpaces, 'analyze-neighborhood-btn': translations[currentLanguage].analyzePotential, 'interpret-city-data-btn': translations[currentLanguage].dataInterpretation, 'interpret-neighborhood-data-btn': translations[currentLanguage].dataInterpretation };
                    button.innerHTML = `<span>${originalTexts[button.id] || ''}</span>`;
                }
            }

            function handleAnalyzeGreenSpaces(e) {
                const cityId = e.currentTarget.dataset.cityId;
                const city = cityData.find(c => c.id === cityId);
                if (!city) return;

                const impactFood = (city.green_ha * 0.1 * 9.5);
                const peopleSustained = ((impactFood * 2000) / 365) / 2;

                const systemPrompt = "You are an expert in urban agriculture, horticulture, sustainable food systems, and project management. Your task is to provide a multi-faceted analysis for a city's potential for urban farming, with a special focus on social impact. Use Markdown for formatting.\n\nStructure the output as follows:\n1.  **Park-Specific Analysis:**\n    * A main title (H4).\n    * A bulleted list of 3-4 major parks. For each, provide its name, approximate size (ha), potential annual food yield (tonnes) from converting 10% of its area (at 9.5 tonnes/ha/year), and equivalent annual food portions (at 0.5kg/portion).\n2.  **City-Wide Context & Social Impact:**\n    * A main title (H4).\n    * Analyze the collective contribution of these parks. Compare their combined potential yield to the city's overall projected impact. Discuss how this initiative contributes to the needs of the city's total population, **emphasizing that the food produced should be primarily directed to sustain vulnerable groups like low-income families and school children.**\n3.  **Stakeholder Benefits:**\n    * A main title (H4).\n    * Outline specific benefits for each stakeholder group: **Influencers**, **Decision-Makers**, **Implementers**, **Collaborators**, and **Supporters**, incorporating the social focus.\n4.  **Estimated Costs & Considerations:**\n    * A main title (H4).\n    * Provide a rough, nation-specific cost estimation for the project (e.g., 'for a project in Germany, costs might range from...'). Briefly break down key costs (soil, irrigation, saplings, tools).\n    * Conclude with a key consideration for implementation, related to the distribution logistics to schools and social services.\n\nBe concise, clear, and present the information logically.";
                const userQuery = `Please provide a strategic analysis for converting green spaces in ${city.name}.
                
                City-wide Data for Context:
                - Total Population: ${city.population.toLocaleString()}
                - Overall Projected Annual Food Production: ${impactFood.toFixed(0)} tonnes
                - Overall Estimated People Sustained Daily: ${Math.floor(peopleSustained)}
                
                Your analysis should:
                1. Identify the largest green spaces and calculate their individual food production potential.
                2. Put the park-specific potential into the context of the city-wide data provided above, with a special consideration that the food produced should be used to sustain mainly poor people and school children.
                3. Detail the benefits for key stakeholder groups,How the circular economy ties to the benefits you care about Community & poor households,City, Health systems, Public safety,Climate resilience. 
                4. Provide a rough cost estimation for project implementation in that country, including any logistical considerations for distributing food to social centers and schools.`;
                const button = e.currentTarget;
                const outputDiv = document.getElementById('gemini-city-output');
                callGeminiAPI(systemPrompt, userQuery, button, outputDiv);
            }

            function handleInterpretCityData(e) {
                const cityId = e.currentTarget.dataset.cityId;
                const city = cityData.find(c => c.id === cityId);
                if (!city) return;

                const impactFood = (city.green_ha * 0.1 * 9.5);
                const foodPortions = impactFood * 2000;

                const systemPrompt = "You are a data interpretation specialist and urban planning guide. Your task is to explain the CECR (City Edible Conversion Readiness) score, its components, and the projected impact to a non-expert user. The tone should be simple, educational, and encouraging. Explain what each metric means in the context of urban agriculture potential. Use Markdown for formatting.";
                const userQuery = `Please provide a simple interpretation of the following data for the city of ${city.name}:\n\n- **Overall CECR Score: ${city.cecr.toFixed(2)}**\n\nExplain this overall score, and then break down each component:\n- **Poverty Need (PN) Score: ${city.pn_z.toFixed(2)}**: What does this score mean for the city's social need for this project?\n- **Accessibility Bonus (AB) Score: ${city.ab_z.toFixed(2)}**: How does this score reflect the location of green spaces relative to vulnerable populations?\n- **Heat/Health Priority (HP) Score: ${city.hp_z.toFixed(2)}**: What does this value tell us about the city's climate and health challenges?\n- **Green Base (GB) Score: ${city.gb_z.toFixed(2)}**: How does this score indicate the city's existing capacity for green projects?\n\nAdditionally, consider the **Projected Impact**:\n- **Estimated Annual Food Production: ${impactFood.toFixed(0)} tonnes/year**\n- **Equivalent Annual Food Portions: ${foodPortions.toLocaleString()}**: Explain what this level of food production means for the city's food security.\n\nConclude with a summary of how to understand all these data points together to evaluate the city's potential.`;
                const button = e.currentTarget;
                const outputDiv = document.getElementById('gemini-city-output');
                callGeminiAPI(systemPrompt, userQuery, button, outputDiv);
            }
            
            const switchView = (view, city = null) => {
                currentView = view;
                cityInfoPanel.classList.add('translate-x-full');
                neighborhoodInfoPanel.classList.add('translate-x-full');
 
                const neighborhoodMenuSection = document.getElementById('neighborhood-menu-section');
                const cityNameLabel = document.getElementById('city-name-label');
                const neighborhoodSubtitle = document.getElementById('neighborhood-analysis-subtitle');
                const neighborhoodMapView = document.getElementById('neighborhood-map-view');
                const selectedCityNameSpan = document.getElementById('selected-city-name-menu');
                const t = translations[currentLanguage];

                if (view === 'city') {
                    // Update header buttons
                    cityViewBtn.classList.add('active-toggle');
                    cityViewBtn.classList.remove('inactive-toggle');
                    neighborhoodViewBtn.classList.add('inactive-toggle');
                    neighborhoodViewBtn.classList.remove('active-toggle');
                    
                    selectedCity = null; // Clear selected city when going back to global view
                    selectedCityNameSpan.textContent = "";

                    // Update map
                    cityMarkers.forEach(marker => { 
                        if (!map.hasLayer(marker)) {
                            map.addLayer(marker);
                        }
                    });
                    neighborhoodMapView.classList.add('hidden');
                    map.flyTo([50, 15], 4.5);
                    switchMapLayer('dark');
                } else {
                    selectedCity = city;
                    if (!selectedCity) { // UI State Fix
                        selectedCity = cityData.find(c => c.id === 'berlin');
                    }
                    currentNeighborhoodLayer = 'nsi'; // Reset to default layer
                    // Update header buttons
                    cityViewBtn.classList.add('inactive-toggle');
                    cityViewBtn.classList.remove('active-toggle');
                    neighborhoodViewBtn.classList.add('active-toggle');
                    neighborhoodViewBtn.classList.remove('inactive-toggle');
                    
                    // Update map
                    cityMarkers.forEach(marker => {
                        if (map.hasLayer(marker)) {
                            map.removeLayer(marker);
                        }
                    });
                    neighborhoodMapView.classList.remove('hidden');
                    const cityName = selectedCity['name_' + currentLanguage] || selectedCity.name;
                    cityNameLabel.textContent = cityName;
                    selectedCityNameSpan.textContent = `: ${cityName}`; // UI State Fix
                    map.flyTo([selectedCity.lat, selectedCity.lng], 12);
                    renderNeighborhoods(selectedCity.id, currentNeighborhoodLayer);
                    switchMapLayer('satellite');
                }
                updateLegend(view);
            };

            function handleAnalyzeNeighborhood(e) {
                const cellId = e.currentTarget.dataset.cellId;
                const cell = neighborhoodData[selectedCity?.id]?.find(c => c.id === cellId);
                if (!cell) return;

                const convertibleHa = 2.0 / (1 + cell.nsi);
                const potentialFood = convertibleHa * 9.5;
                const potentialPortions = potentialFood * 2000;

                const systemPrompt = "You are an expert in micro-scale urban planning and sustainable community development. Your task is to analyze a neighborhood's potential for greening projects. Your analysis must start by explaining how the 'Potential Impact' figures are calculated based on the provided NSI score and planning assumptions. Then, build upon that with a more detailed plan. Use Markdown for clear formatting.How the circular economy ties to the benefits you care about Community & poor households,City, Health systems, Public safety,Climate resilience.";
                const userQuery = `Analyze the potential benefits for Neighborhood Cell ${cell.id.split('-').pop().toUpperCase()} in ${selectedCity.name}. This area has the following data:\n- NSI Score: ${cell.nsi.toFixed(2)}\n- Est. Convertible Area: ${convertibleHa.toFixed(1)} ha\n- Est. Annual Food Production: ${potentialFood.toFixed(1)} tonnes\n- Est. Annual Food Portions: ${Math.round(potentialPortions).toLocaleString()}\n\nFirst, explain how these 'Potential Impact' figures are calculated using these assumptions:\n- **Est. Convertible Area** = 2.0 ha / (1 + NSI Score)\n- **Est. Food Production** = Convertible Area * 9.5 tonnes/ha/year\n- **Est. Food Portions** = Food Production (in kg) / 0.5 kg/portion\n\nThen, provide a more detailed analysis. Suggest specific types of interventions (e.g., street-side micro-orchards, community garden plots), recommend a mix of 3-4 climate-appropriate fruit trees or vegetables for ${selectedCity.name}, and estimate the potential local cooling effect in degrees Celsius.`;
                const button = e.currentTarget;
                const outputDiv = document.getElementById('gemini-neighborhood-output');
                callGeminiAPI(systemPrompt, userQuery, button, outputDiv);
            };

            function handleInterpretNeighborhoodData(e) {
                const cellId = e.currentTarget.dataset.cellId;
                const cell = neighborhoodData[selectedCity?.id]?.find(c => c.id === cellId);
                if (!cell) return;

                const convertibleHa = 2.0 / (1 + cell.nsi);
                const potentialFood = convertibleHa * 9.5;
                const potentialPortions = potentialFood * 2000;

                const systemPrompt = "You are a data interpretation specialist and community planning guide. Your task is to explain the NSI (NutriShade Index), its components, and the projected 'Potential Impact' to a non-expert user. The tone should be simple and educational. Use Markdown for formatting.";
                const userQuery = `Please provide a simple interpretation of the following data for Neighborhood Cell ${cell.id.split('-').pop().toUpperCase()} in ${selectedCity.name}:\n\n- **Overall NSI Score: ${cell.nsi.toFixed(2)}**\n- **Green Access Deficit (GAD%): ${cell.gad_p}%**\n- **Heat Burden (HB): ${cell.hb_p}th percentile**\n- **Density Boost (DB) Score: ${cell.db_z.toFixed(2)}**\n- **Est. Population: ${cell.population.toLocaleString()}**\n\nFirst, explain what the NSI score and its components (GAD, HB, DB) mean for prioritizing this area.\n\nThen, explain the **Potential Impact** figures below and how they are calculated based on the NSI score and standard assumptions:\n- **Est. Convertible Area: ${convertibleHa.toFixed(1)} ha** (Calculated as 2.0 ha / (1 + NSI Score))\n- **Est. Annual Food Production: ${potentialFood.toFixed(1)} tonnes** (Calculated from area * 9.5 tonnes/ha)\n- **Est. Annual Food Portions: ${Math.round(potentialPortions).toLocaleString()}** (Calculated from tonnes * 2000 portions/tonne)\n\nConclude with a summary of why a high NSI score indicates a top-priority location that can yield significant benefits.`;
                const button = e.currentTarget;
                const outputDiv = document.getElementById('gemini-neighborhood-output');
                callGeminiAPI(systemPrompt, userQuery, button, outputDiv);
            }

            initMap();
            
            const menuToggleBtn = document.getElementById('menu-toggle-btn');
            const menuOpenIcon = document.getElementById('menu-open-icon');
            const menuCloseIcon = document.getElementById('menu-close-icon');
            const controlPanel = document.getElementById('control-panel');
            const menuOverlay = document.getElementById('menu-overlay');
            const menuCloseBtnPanel = document.getElementById('menu-close-btn-panel');
            const guideBtn = document.getElementById('guide-btn');
            const stakeholderBtn = document.getElementById('stakeholder-btn');
            const guideModal = document.getElementById('guide-modal');
            const stakeholderModal = document.getElementById('stakeholder-modal');
            const closeGuideModal = document.getElementById('close-guide-modal');
            const closeStakeholderModal = document.getElementById('close-stakeholder-modal');
            const langSwitcherGuide = document.getElementById('lang-switcher-guide');
            const apiKeyInput = document.getElementById('api-key-input');
            const saveApiKeyBtn = document.getElementById('save-api-key-btn');
            const apiKeyStatus = document.getElementById('api-key-status');

            // New Menu Buttons
            const menuGuideBtn = document.getElementById('menu-guide-btn');
            const menuStakeholderBtn = document.getElementById('menu-stakeholder-btn');
            const menuCecrBtn = document.getElementById('menu-cecr-btn');
            const menuNsiBtn = document.getElementById('menu-nsi-btn');

            const toggleMenu = () => {
                controlPanel.classList.toggle('-translate-x-full');
                controlPanel.classList.toggle('translate-x-0');
                menuOverlay.classList.toggle('hidden');
                menuOpenIcon.classList.toggle('hidden');
                menuCloseIcon.classList.toggle('hidden');
            };

            const guideModalContent = document.querySelector('#guide-modal .overflow-y-auto');

            const openGuide = () => {
                guideModal.classList.remove('hidden');
                guideModal.classList.add('flex');
            };
            const closeGuide = () => {
                guideModal.classList.add('hidden');
                guideModal.classList.remove('flex');
            };

            const openStakeholder = () => {
                stakeholderModal.classList.remove('hidden');
                stakeholderModal.classList.add('flex');
            };
            const closeStakeholder = () => {
                stakeholderModal.classList.add('hidden');
                stakeholderModal.classList.remove('flex');
            };

            guideBtn.addEventListener('click', openGuide);
            closeGuideModal.addEventListener('click', closeGuide);
            guideModal.addEventListener('click', (e) => {
                if (e.target === guideModal) closeGuide();
            });

            stakeholderBtn.addEventListener('click', openStakeholder);
            closeStakeholderModal.addEventListener('click', closeStakeholder);
            
            // New Menu Button Listeners
            menuGuideBtn.addEventListener('click', () => {
                openGuide();
                toggleMenu();
            });
            menuStakeholderBtn.addEventListener('click', () => {
                openStakeholder();
                toggleMenu();
            });
            menuCecrBtn.addEventListener('click', () => {
                switchView('city');
                toggleMenu();
            });
            menuNsiBtn.addEventListener('click', () => {
                switchView('neighborhood', selectedCity || cityData.find(c => c.id === 'berlin'));
                toggleMenu();
            });

            stakeholderModal.addEventListener('click', (e) => {
                if (e.target === stakeholderModal) closeStakeholder();
            });

            langSwitcherGuide.addEventListener('click', () => setLanguage(currentLanguage === 'en' ? 'it' : 'en'));

            const toggleApiKeyBtn = document.getElementById('toggle-api-key-section-btn');
            const apiKeyContent = document.getElementById('api-key-content');
            if(toggleApiKeyBtn) {
                toggleApiKeyBtn.addEventListener('click', () => {
                    apiKeyContent.classList.toggle('hidden');
                });
            }

            const checkApiKey = () => {
                const apiKey = localStorage.getItem('geminiApiKey');
                const aiButtons = document.querySelectorAll('#interpret-city-data-btn, #analyze-green-areas-btn, #interpret-neighborhood-data-btn, #analyze-neighborhood-btn');
                const keyToUse = apiKey || defaultApiKey;

                if (keyToUse) {
                    apiKeyInput.value = keyToUse;
                    aiButtons.forEach(btn => {
                        btn.disabled = false;
                        btn.title = '';
                        btn.classList.remove('disabled:opacity-50', 'disabled:cursor-not-allowed');
                    });
                    return true;
                } else {
                    apiKeyInput.value = ""; // Clear the input if no key is found
                    aiButtons.forEach(btn => {
                        btn.disabled = true;
                        btn.title = 'Enter API Key to enable';
                        btn.classList.add('disabled:opacity-50', 'disabled:cursor-not-allowed');
                    });
                    return false;
                }
            };

            saveApiKeyBtn.addEventListener('click', () => {
                const apiKey = apiKeyInput.value.trim();
                if (apiKey) {
                    localStorage.setItem('geminiApiKey', apiKey);
                    apiKeyStatus.classList.remove('hidden');
                    setTimeout(() => apiKeyStatus.classList.add('hidden'), 3000);
                    checkApiKey();
                } else {
                    localStorage.removeItem('geminiApiKey');
                    checkApiKey();
                }
            });

            // Re-check api key status when panels are opened
            const observer = new MutationObserver((mutations) => {
                for (let mutation of mutations) {
                    if (mutation.attributeName === 'class') {
                        checkApiKey();
                    }
                }
            });
            observer.observe(cityInfoPanel, { attributes: true });
            observer.observe(neighborhoodInfoPanel, { attributes: true });

            menuToggleBtn.addEventListener('click', toggleMenu);
            menuOverlay.addEventListener('click', toggleMenu);
            menuCloseBtnPanel.addEventListener('click', toggleMenu);
            
            window.addEventListener('resize', () => {
                if(currentLanguage) setLanguage(currentLanguage);
            });

            const disclaimerBanner = document.getElementById('disclaimer-banner');
            const closeDisclaimerBtn = document.getElementById('close-disclaimer');
            if (disclaimerBanner && closeDisclaimerBtn) {
                closeDisclaimerBtn.addEventListener('click', () => {
                    disclaimerBanner.style.display = 'none';
                });
            }

            cityViewBtn.addEventListener('click', () => switchView('city'));
            neighborhoodViewBtn.addEventListener('click', () => {
                if (selectedCity) {
                    switchView('neighborhood', selectedCity);
                } else {
                    // Default to Berlin if no city was ever selected
                    switchView('neighborhood', cityData.find(c => c.id === 'berlin'));
                }
            });

            cityRankingList.addEventListener('click', (e) => {
                const cityEl = e.target.closest('[data-city-id]'); 
                if (cityEl) {
                    const city = cityData.find(c => c.id === cityEl.dataset.cityId);
                    if (city) {
                        // If current view is neighborhood, switch back to city view first
                        if (currentView !== 'city') {
                            switchView('city');
                        }
                        renderCityInfo(city);
                        // Fly map to the selected city for better context
                        map.flyTo([city.lat, city.lng], 8); 
                        
                        cityListContainer.classList.add('hidden');
                        cityListArrow.classList.remove('rotate-180');
                    }
                }
            });
            hexGrid.addEventListener('click', (e) => {
                const hexEl = e.target.closest('[data-cell-id]'); if (hexEl && selectedCity) renderNeighborhoodInfo(neighborhoodData[selectedCity.id].find(c => c.id === hexEl.dataset.cellId));
            });
            
            setLanguage('en');
            switchView('city');
            checkApiKey();

            // Open guide on first visit
            if (!localStorage.getItem('terravitalis_visited')) {
                openGuide();
                localStorage.setItem('terravitalis_visited', 'true');
            }
        });
    </script>
</body>
</html>










